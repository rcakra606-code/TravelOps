<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Settings | TravelOps</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/app-v2.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/modal.css">
  <link rel="stylesheet" href="/css/filters.css">
  <link rel="stylesheet" href="/css/table-enhancements.css">
  <link rel="stylesheet" href="/css/filter-enhancements.css">
  <link rel="stylesheet" href="/css/status-badges.css">
  <link rel="stylesheet" href="/css/animations.css">
  <link rel="stylesheet" href="/css/mobile-responsive.css">
  <link rel="stylesheet" href="/css/dashboard-customization.css">
  <link rel="stylesheet" href="/css/empty-states.css">
  <link rel="stylesheet" href="/css/form-enhancements.css">
  <link rel="stylesheet" href="/css/crud-enhancements.css">
  <link rel="stylesheet" href="/css/filter-modal.css">
  <link rel="stylesheet" href="/css/ui-enhancements.css">
  <link rel="stylesheet" href="/css/sidebar-groups.css">
<link rel="stylesheet" href="/css/dashboard-shared.css">
  <link rel="stylesheet" href="/css/accessibility.css">
<link rel="stylesheet" href="/css/professional-polish.css">
<link rel="stylesheet" href="/css/seasonal-theme.css">
<link rel="stylesheet" href="/css/micro-interactions.css">
<script src="/js/seasonal-theme.js"></script>
  <style>
    .settings-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-alt, #f3f4f6);
      padding: 8px;
      border-radius: 12px 12px 0 0;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
    }
    
    .settings-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary, #6b7280);
      transition: all 0.2s;
    }
    
    .settings-tab:hover {
      color: var(--text-primary, #1f2937);
    }
    
    .settings-tab.active {
      background: var(--card, #fff);
      color: var(--primary, #3b82f6);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .settings-panel {
      display: none;
      padding: 24px;
    }
    
    .settings-panel.active {
      display: block;
    }
    
    .settings-section {
      margin-bottom: 30px;
    }
    
    .settings-section:last-child {
      margin-bottom: 0;
    }
    
    .settings-section h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
    }
    
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
    }
    
    .setting-row:last-child {
      border-bottom: none;
    }
    
    .setting-info {
      flex: 1;
    }
    
    .setting-label {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .setting-description {
      font-size: 13px;
      color: var(--text-secondary, #6b7280);
    }
    
    .setting-control {
      margin-left: 20px;
    }
    
    .setting-control input[type="text"],
    .setting-control input[type="number"],
    .setting-control input[type="email"],
    .setting-control input[type="password"],
    .setting-control select {
      padding: 8px 12px;
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
      background: var(--card, #fff);
      color: var(--text-primary, #1f2937);
    }
    
    /* Table inputs - smaller for table cells */
    table input[type="number"] {
      padding: 6px 10px;
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 6px;
      font-size: 13px;
      background: var(--card, #fff);
      color: var(--text-primary, #1f2937);
      transition: all 0.2s;
    }
    
    table input[type="number"]:focus {
      outline: none;
      border-color: var(--primary, #3b82f6);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    table input[type="number"]:disabled {
      background: var(--bg-alt, #f3f4f6);
      color: var(--text-secondary, #6b7280);
      cursor: not-allowed;
    }
    
    .setting-control input:focus,
    .setting-control select:focus {
      outline: none;
      border-color: var(--primary, #3b82f6);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--border-light, #e5e7eb);
      transition: 0.3s;
      border-radius: 26px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
      background: var(--primary, #3b82f6);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    /* Action buttons */
    .settings-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-light, #e5e7eb);
    }
    
    .btn-save {
      padding: 10px 24px;
      background: var(--primary, #3b82f6);
      color: white;
      border: none;
      border-radius: 7px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-save:hover {
      background: var(--primary-dark, #2563eb);
    }
    
    .btn-reset {
      padding: 10px 24px;
      background: transparent;
      color: var(--text-secondary, #6b7280);
      border: 1px solid var(--border-light, #e5e7eb);
      border-radius: 7px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-reset:hover {
      background: var(--bg-alt, #f3f4f6);
    }
    
    /* System Status Cards */
    .status-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .status-card {
      background: var(--bg-alt, #f8fafc);
      padding: 16px;
      border-radius: 10px;
      text-align: center;
    }
    
    .status-card-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .status-card-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary, #3b82f6);
    }
    
    .status-card-label {
      font-size: 13px;
      color: var(--text-secondary, #6b7280);
      margin-top: 4px;
    }
    
    /* Activity Log */
    .activity-log {
      max-height: 400px;
      overflow-y: auto;
      background: var(--bg-alt, #f8fafc);
      border-radius: 10px;
      padding: 4px;
    }
    
    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--card, #fff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-message {
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .activity-time {
      font-size: 12px;
      color: var(--text-secondary, #6b7280);
    }
    
    /* Backup Section */
    .backup-list {
      background: var(--bg-alt, #f8fafc);
      border-radius: 10px;
      padding: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .backup-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
    }
    
    .backup-item:last-child {
      border-bottom: none;
    }
    
    .backup-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .backup-icon {
      font-size: 24px;
    }
    
    .backup-name {
      font-weight: 500;
    }
    
    .backup-date {
      font-size: 12px;
      color: var(--text-secondary, #6b7280);
    }
    
    .backup-actions button {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 8px;
    }
    
    .btn-download {
      background: var(--primary, #3b82f6);
      color: white;
      border: none;
    }
    
    .btn-delete-backup {
      background: transparent;
      color: var(--danger, #ef4444);
      border: 1px solid var(--danger, #ef4444);
    }
    
    /* Import/Export */
    .import-export-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .import-export-card {
      background: var(--bg-alt, #f8fafc);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    
    .import-export-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }
    
    .import-export-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .import-export-desc {
      font-size: 13px;
      color: var(--text-secondary, #6b7280);
      margin-bottom: 16px;
    }
    
    .dropzone {
      border: 2px dashed var(--border-light, #e5e7eb);
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    
    .dropzone:hover,
    .dropzone.dragover {
      border-color: var(--primary, #3b82f6);
      background: rgba(59, 130, 246, 0.05);
    }
    
    .dropzone-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .dropzone-text {
      color: var(--text-secondary, #6b7280);
      font-size: 13px;
    }
    
    .entity-select {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .entity-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--card, #fff);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    
    .entity-option:hover {
      background: var(--border-light, #e5e7eb);
    }
    
    .entity-option input {
      width: 16px;
      height: 16px;
    }
    
    /* Settings table styling */
    .settings-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .settings-table th {
      padding: 12px 14px;
      text-align: left;
      background: var(--bg-alt, #f8fafc);
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary, #1f2937);
      border-bottom: 2px solid var(--border-light, #e5e7eb);
    }
    
    .settings-table td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-light, #e5e7eb);
      vertical-align: middle;
    }
    
    .settings-table tr:hover {
      background: var(--bg-alt, #f8fafc);
    }
    
    /* Fix inputs in settings rows */
    .setting-control input[type="number"][style*="width: 80px"] {
      min-width: 80px;
      max-width: 100px;
    }
    
    /* Responsive fixes */
    @media (max-width: 768px) {
      .setting-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .setting-control {
        margin-left: 0;
        width: 100%;
      }
      
      .setting-control input,
      .setting-control select {
        width: 100%;
        min-width: unset;
      }
    }
  </style>
</head>
<body>
<button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">‚ò∞</button>
<div class="mobile-overlay" id="mobileOverlay"></div>
<div class="app">
  <aside class="sidebar">
    <div class="brand">üöÄ TravelOps</div>
    <div class="nav">
      <!-- Main Dashboard -->
      <a href="/single-dashboard.html" class="nav-main-item">üè† Main Dashboard</a>
      
      <!-- Product Input Group -->
      <div class="nav-group" id="groupProductInput">
        <button class="nav-group-header" data-group="product-input">
          <span class="group-icon">üì¶</span>
          <span class="group-title">Product Input</span>
          <span class="group-arrow">‚ñº</span>
        </button>
        <div class="nav-group-items">
          <a href="/tours-dashboard.html">üß≥ Tours</a>
          <a href="/my-tours.html">üìã My Tours</a>
          <a href="/documents-dashboard.html">üìÑ Documents</a>
          <a href="/hotel-dashboard.html">üè® Hotel</a>
          <a href="/cruise-dashboard.html">üö¢ Cruise</a>
          <a href="/telecom-dashboard.html">üìû Telecom</a>
          <a href="/tracking-dashboard.html">üì¶ Tracking</a>
          <a href="/ticket-recap-dashboard.html">‚úàÔ∏è Ticket Recap</a>
        </div>
      </div>
      
      <!-- Productivity Group -->
      <div class="nav-group" id="groupProductivity">
        <button class="nav-group-header" data-group="productivity">
          <span class="group-icon">üìä</span>
          <span class="group-title">Productivity</span>
          <span class="group-arrow">‚ñº</span>
        </button>
        <div class="nav-group-items">
          <a href="/sales-targets-dashboard.html">üí∞ Sales & Target</a>
          <a href="/overtime-dashboard.html">‚è∞ Overtime</a>
          <a href="/productivity-dashboard.html">üìà Productivity</a>
        </div>
      </div>
      
      <!-- Administration Group -->
      <div class="nav-group" id="groupAdmin">
        <button class="nav-group-header" data-group="administration">
          <span class="group-icon">‚öôÔ∏è</span>
          <span class="group-title">Administration</span>
          <span class="group-arrow">‚ñº</span>
        </button>
        <div class="nav-group-items">
          <a href="/outstanding-dashboard.html">üìã Outstanding</a>
          <a href="/cashout-dashboard.html">üí∏ Cash Out</a>
          <a href="/admin-settings.html" class="active">‚öôÔ∏è Admin Settings</a>
          <a href="/logs-dashboard.html">üìã System Logs</a>
        </div>
      </div>
      
      <hr class="nav-divider">
      <a href="/profile.html">üë§ Profile</a>
      <a href="/logout.html" id="logoutLink">üö™ Logout</a>
    </div>
    <div class="userbox" style="margin-top:18px">
      <div id="userName">‚Äî</div>
      <div id="userRole">‚Äî</div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h2>Admin Settings</h2>
        <div class="small">System configuration and management</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="card" style="padding: 0;">
      <!-- Settings Tabs -->
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="general">‚öôÔ∏è General</button>
        <button class="settings-tab" data-tab="users">üë• Users</button>
        <button class="settings-tab" data-tab="sessions">üîê Sessions</button>
        <button class="settings-tab" data-tab="regions">üåç Regions</button>
        <button class="settings-tab" data-tab="email">üìß Email</button>
        <button class="settings-tab" data-tab="backup">üíæ Backup</button>
        <button class="settings-tab" data-tab="import-export">üì¶ Import/Export</button>
        <button class="settings-tab" data-tab="activity">üìú Activity Log</button>
        <button class="settings-tab" data-tab="system">üñ•Ô∏è System</button>
      </div>

      <!-- General Settings Panel -->
      <div class="settings-panel active" id="panel-general">
        <div class="settings-section">
          <h3>Application Settings</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Company Name</div>
              <div class="setting-description">Displayed in headers and reports</div>
            </div>
            <div class="setting-control">
              <input type="text" id="companyName" value="TravelOps Pro">
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Date Format</div>
              <div class="setting-description">Format for displaying dates</div>
            </div>
            <div class="setting-control">
              <select id="dateFormat">
                <option value="YYYY-MM-DD">2024-01-15</option>
                <option value="DD/MM/YYYY">15/01/2024</option>
                <option value="MM/DD/YYYY">01/15/2024</option>
                <option value="DD MMM YYYY">15 Jan 2024</option>
              </select>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Currency</div>
              <div class="setting-description">Default currency for financial data</div>
            </div>
            <div class="setting-control">
              <select id="currency">
                <option value="IDR" selected>IDR (Indonesian Rupiah)</option>
                <option value="MYR">MYR (Malaysian Ringgit)</option>
                <option value="USD">USD (US Dollar)</option>
                <option value="EUR">EUR (Euro)</option>
                <option value="GBP">GBP (British Pound)</option>
                <option value="SGD">SGD (Singapore Dollar)</option>
              </select>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Items Per Page</div>
              <div class="setting-description">Number of items per page in tables</div>
            </div>
            <div class="setting-control">
              <select id="itemsPerPage">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>User Interface</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Animations</div>
              <div class="setting-description">Enable UI animations</div>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" id="animations" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Auto-Refresh</div>
              <div class="setting-description">Auto-refresh dashboard data</div>
            </div>
            <div class="setting-control">
              <select id="autoRefresh">
                <option value="0">Disabled</option>
                <option value="60000">Every 1 minute</option>
                <option value="300000" selected>Every 5 minutes</option>
                <option value="600000">Every 10 minutes</option>
              </select>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Sound Notifications</div>
              <div class="setting-description">Play sound for important alerts</div>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" id="soundNotifications">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>üìä Productivity Margin Benchmarks</h3>
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
            Configure profit margin thresholds per product category. Margins are color-coded: 
            <span style="color: #047857; font-weight: 600;">Green (High)</span>, 
            <span style="color: #b45309; font-weight: 600;">Yellow (Medium)</span>, 
            <span style="color: #b91c1c; font-weight: 600;">Red (Low)</span>.
          </p>
          
          <!-- Default Thresholds -->
          <div style="background: var(--bg-alt, #f8fafc); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-primary);">‚öôÔ∏è Default Thresholds (used when product-specific not set)</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div class="setting-row" style="margin: 0; padding: 0; border: none;">
                <div class="setting-info">
                  <div class="setting-label">High Margin (%)</div>
                </div>
                <div class="setting-control">
                  <input type="number" id="marginHighThreshold" min="0" max="100" step="0.1" value="20" style="width: 80px;">
                </div>
              </div>
              <div class="setting-row" style="margin: 0; padding: 0; border: none;">
                <div class="setting-info">
                  <div class="setting-label">Medium Margin (%)</div>
                </div>
                <div class="setting-control">
                  <input type="number" id="marginMediumThreshold" min="0" max="100" step="0.1" value="10" style="width: 80px;">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Per-Product Thresholds -->
          <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-primary);">üì¶ Per-Product Thresholds</h4>
          <div style="overflow-x: auto; background: var(--card, #fff); border-radius: 8px; border: 1px solid var(--border-light, #e5e7eb);">
            <table class="settings-table">
              <thead>
                <tr>
                  <th style="min-width: 150px;">Product</th>
                  <th style="text-align: center; min-width: 120px;">High Margin (%)</th>
                  <th style="text-align: center; min-width: 120px;">Medium Margin (%)</th>
                  <th style="text-align: center; min-width: 100px;">Use Default</th>
                </tr>
              </thead>
              <tbody id="productMarginTable">
                <!-- Generated by JS -->
              </tbody>
            </table>
          </div>
          
          <div style="background: var(--bg-alt, #f8fafc); border-radius: 8px; padding: 12px; margin-top: 16px;">
            <div style="font-size: 13px; color: var(--text-secondary);">
              <strong>Color Legend:</strong>
              <span style="display: inline-flex; gap: 12px; margin-top: 8px;">
                <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #047857;">‚â• High = Green</span>
                <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #b45309;">‚â• Medium = Yellow</span>
                <span style="padding: 4px 10px; border-radius: 12px; font-size: 12px; background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #b91c1c;">&lt; Medium = Red</span>
              </span>
            </div>
          </div>
        </div>

        <div class="settings-actions">
          <button class="btn-save" onclick="saveGeneralSettings()">üíæ Save Settings</button>
          <button class="btn-reset" onclick="resetGeneralSettings()">‚Ü©Ô∏è Reset to Default</button>
        </div>
      </div>

      <!-- Users Management Panel -->
      <div class="settings-panel" id="panel-users">
        <div class="settings-section">
          <h3>User Management</h3>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; flex: 1;">
              <input type="text" id="userSearchInput" placeholder="Search by username, name, or email..." style="flex: 1; max-width: 300px;">
              <select id="userTypeFilter">
                <option value="">All Types</option>
                <option value="admin">Admin</option>
                <option value="semi-admin">Semi Admin</option>
                <option value="basic">Basic</option>
              </select>
            </div>
            <button class="btn-save" onclick="showAddUserModal()">+ Add User</button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--bg-alt); text-align: left;">
                  <th style="padding: 12px;">Username</th>
                  <th style="padding: 12px;">Name</th>
                  <th style="padding: 12px;">Email</th>
                  <th style="padding: 12px;">Type</th>
                  <th style="padding: 12px;">Status</th>
                  <th style="padding: 12px;">Last Login</th>
                  <th style="padding: 12px;">Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading users...</td></tr>
              </tbody>
            </table>
          </div>
          <div id="usersPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
        </div>
        
        <!-- System Health Stats -->
        <div class="settings-section">
          <h3>System Health Dashboard</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div class="status-card">
              <div class="status-card-icon">üë•</div>
              <div class="status-card-value" id="statTotalUsersAdmin">-</div>
              <div class="status-card-label">Total Users</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">‚úÖ</div>
              <div class="status-card-value" id="statActiveUsersAdmin">-</div>
              <div class="status-card-label">Active (24h)</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">üîí</div>
              <div class="status-card-value" id="statLockedUsersAdmin">-</div>
              <div class="status-card-label">Locked Users</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">üìä</div>
              <div class="status-card-value" id="statTotalRecordsAdmin">-</div>
              <div class="status-card-label">Total Records</div>
            </div>
          </div>
          <button class="btn-reset" onclick="refreshUserStats()">üîÑ Refresh Stats</button>
        </div>
      </div>

      <!-- Active Sessions Panel -->
      <div class="settings-panel" id="panel-sessions">
        <div class="settings-section">
          <h3>Active Sessions</h3>
          <p style="color: var(--text-secondary); margin-bottom: 16px;">
            Manage currently active user sessions. Each user can only be logged in on one device at a time.
          </p>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div class="status-card" style="margin: 0; padding: 12px 20px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üü¢</span>
                <div>
                  <div class="status-card-value" id="activeSessionCount" style="font-size: 20px;">0</div>
                  <div class="status-card-label">Active Sessions</div>
                </div>
              </div>
            </div>
            <button class="btn-reset" onclick="loadActiveSessions()">üîÑ Refresh</button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--bg-alt); text-align: left;">
                  <th style="padding: 12px;">User</th>
                  <th style="padding: 12px;">Role</th>
                  <th style="padding: 12px;">Login Time</th>
                  <th style="padding: 12px;">IP Address</th>
                  <th style="padding: 12px;">Actions</th>
                </tr>
              </thead>
              <tbody id="sessionsTableBody">
                <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading sessions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="settings-section">
          <h3>Session Security</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Single Device Policy</div>
              <div class="setting-description">Users can only be logged in on one device at a time. New logins will prompt to terminate existing session.</div>
            </div>
            <div class="setting-control">
              <span style="color: #10b981; font-weight: 600;">‚úì Enabled</span>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Session Timeout</div>
              <div class="setting-description">Users are automatically logged out after 30 minutes of inactivity</div>
            </div>
            <div class="setting-control">
              <span style="color: var(--text-secondary);">30 minutes</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Regions Management Panel -->
      <div class="settings-panel" id="panel-regions">
        <div class="settings-section">
          <h3>Region Management</h3>
          <p style="color: var(--text-secondary); margin-bottom: 16px;">Manage regions for sales and tour data categorization.</p>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <input type="text" id="regionSearchInput" placeholder="Search regions..." style="flex: 1; max-width: 300px; padding: 8px 12px; border: 1px solid var(--border-light); border-radius: 6px;">
            <button class="btn-save" onclick="showAddRegionModal()">+ Add Region</button>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: var(--bg-alt); text-align: left;">
                  <th style="padding: 12px;">ID</th>
                  <th style="padding: 12px;">Region Name</th>
                  <th style="padding: 12px;">Description</th>
                  <th style="padding: 12px;">Sales Count</th>
                  <th style="padding: 12px;">Actions</th>
                </tr>
              </thead>
              <tbody id="regionsTableBody">
                <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading regions...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Email Settings Panel -->
      <div class="settings-panel" id="panel-email">
        <!-- Email Configuration Status -->
        <div id="emailConfigStatus" style="padding: 20px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center; gap: 16px;">
          <span id="emailStatusIcon" style="font-size: 32px;">‚è≥</span>
          <div>
            <strong id="emailStatusTitle" style="font-size: 16px;">Checking email configuration...</strong>
            <p id="emailStatusMessage" style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.9rem;"></p>
          </div>
        </div>

        <div class="settings-section">
          <h3>üìß Email Configuration</h3>
          <div style="background: var(--bg-alt); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin: 0 0 12px 0; color: var(--text-secondary);">
              <strong>Note:</strong> Email configuration is set via environment variables on the server (Render).
            </p>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
              Required variables: <code>SMTP_USER</code>, <code>SMTP_PASSWORD</code><br>
              Optional: <code>SMTP_HOST</code> (default: smtp.gmail.com), <code>SMTP_PORT</code> (default: 587)
            </p>
          </div>
        </div>

        <div class="settings-section">
          <h3>üîß Email Actions</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Test Email</div>
              <div class="setting-description">Send a test email to verify SMTP configuration</div>
            </div>
            <div class="setting-control" style="display: flex; gap: 10px;">
              <input type="email" id="testEmailAddress" placeholder="test@email.com">
              <button class="btn-reset" onclick="testEmail()">üìß Send Test</button>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Manual Reminder Trigger</div>
              <div class="setting-description">Manually send departure reminders for upcoming tours</div>
            </div>
            <div class="setting-control">
              <button class="btn-reset" onclick="triggerReminders()">üîî Trigger Reminders</button>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Reminder Statistics</div>
              <div class="setting-description">View email reminder statistics</div>
            </div>
            <div class="setting-control">
              <button class="btn-reset" onclick="loadReminderStats()">üìä View Stats</button>
            </div>
          </div>
        </div>

        <div id="reminderStatsPanel" style="display:none; margin-top: 20px; padding: 16px; background: var(--bg-alt); border-radius: 8px;">
          <h4 style="margin-bottom: 12px;">üìä Reminder Statistics</h4>
          <div id="reminderStatsContent">Loading...</div>
        </div>

        <div id="testEmailResult" style="display:none; margin-top: 16px;"></div>
      </div>

      <!-- Backup Panel -->
      <div class="settings-panel" id="panel-backup">
        <div class="settings-section">
          <h3>Backup Configuration</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Automatic Backups</div>
              <div class="setting-description">Automatically backup data</div>
            </div>
            <div class="setting-control">
              <label class="toggle-switch">
                <input type="checkbox" id="autoBackup" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Backup Frequency</div>
              <div class="setting-description">How often to create backups</div>
            </div>
            <div class="setting-control">
              <select id="backupFrequency">
                <option value="daily" selected>Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Keep Backups For</div>
              <div class="setting-description">Retention period</div>
            </div>
            <div class="setting-control">
              <select id="backupRetention">
                <option value="7">7 days</option>
                <option value="30" selected>30 days</option>
                <option value="90">90 days</option>
                <option value="365">1 year</option>
              </select>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Manual Backup</h3>
          <button class="btn-save" onclick="createBackup()" style="margin-bottom: 20px;">
            üíæ Create Backup Now
          </button>

          <h3>Available Backups</h3>
          <div class="backup-list" id="backupList">
            <div style="text-align:center;padding:40px;color:var(--text-secondary);">
              <div style="font-size:48px;margin-bottom:12px;">üì¶</div>
              <div>Click on this tab to load backups</div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Restore Backup</h3>
          <div class="dropzone" id="restoreDropzone">
            <div class="dropzone-icon">üì§</div>
            <div class="dropzone-text">Drop backup file here or click to browse</div>
            <input type="file" id="restoreFile" accept=".json,.db" style="display:none">
          </div>
        </div>
      </div>

      <!-- Import/Export Panel -->
      <div class="settings-panel" id="panel-import-export">
        <div class="import-export-grid">
          <div class="import-export-card">
            <div class="import-export-icon">üì•</div>
            <div class="import-export-title">Import Data</div>
            <div class="import-export-desc">Import data from CSV files</div>
            <div class="dropzone" id="importDropzone">
              <div class="dropzone-icon">üìÑ</div>
              <div class="dropzone-text">Drop CSV file here</div>
              <input type="file" id="importFile" accept=".csv" style="display:none">
            </div>
            <div class="entity-select">
              <label class="entity-option">
                <input type="radio" name="importEntity" value="sales" checked>
                <span>Sales</span>
              </label>
              <label class="entity-option">
                <input type="radio" name="importEntity" value="tours">
                <span>Tours</span>
              </label>
              <label class="entity-option">
                <input type="radio" name="importEntity" value="documents">
                <span>Documents</span>
              </label>
              <label class="entity-option">
                <input type="radio" name="importEntity" value="hotel_bookings">
                <span>Hotels</span>
              </label>
              <label class="entity-option">
                <input type="radio" name="importEntity" value="productivity">
                <span>Productivity</span>
              </label>
              <label class="entity-option">
                <input type="radio" name="importEntity" value="targets">
                <span>Targets</span>
              </label>
            </div>
            <button class="btn-save" onclick="importData()" style="width: 100%;">üì• Import</button>
          </div>

          <div class="import-export-card">
            <div class="import-export-icon">üì§</div>
            <div class="import-export-title">Export Data</div>
            <div class="import-export-desc">Export data to CSV or JSON</div>
            <div class="entity-select" style="margin-top: 20px;">
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="sales" checked>
                <span>Sales</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="tours" checked>
                <span>Tours</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="documents" checked>
                <span>Documents</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="hotel_bookings" checked>
                <span>Hotels</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="cruise" checked>
                <span>Cruise</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="telecom" checked>
                <span>Telecom</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="productivity" checked>
                <span>Productivity</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="targets" checked>
                <span>Targets</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="overtime" checked>
                <span>Overtime</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="outstanding" checked>
                <span>Outstanding</span>
              </label>
              <label class="entity-option">
                <input type="checkbox" name="exportEntity" value="cashout" checked>
                <span>Cash Out</span>
              </label>
            </div>
            <select id="exportFormat" style="width: 100%; padding: 10px; margin-bottom: 12px; border-radius: 6px; border: 1px solid var(--border-light);">
              <option value="csv">CSV Format</option>
              <option value="json">JSON Format</option>
            </select>
            <button class="btn-save" onclick="exportData()" style="width: 100%;">üì§ Export</button>
          </div>
        </div>
      </div>

      <!-- Activity Log Panel -->
      <div class="settings-panel" id="panel-activity">
        <div class="settings-section">
          <h3>Activity Log</h3>
          <div style="display: flex; gap: 10px; margin-bottom: 16px;">
            <select id="activityFilter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-light);">
              <option value="all">All Activities</option>
              <option value="create">Created</option>
              <option value="update">Updated</option>
              <option value="delete">Deleted</option>
              <option value="login">Login/Logout</option>
            </select>
            <select id="activityEntity" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-light);">
              <option value="all">All Entities</option>
              <option value="sales">Sales</option>
              <option value="tours">Tours</option>
              <option value="documents">Documents</option>
              <option value="targets">Targets</option>
            </select>
            <input type="date" id="activityDate" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-light);">
            <button class="btn-save" onclick="filterActivity()">üîç Filter</button>
          </div>
          <div class="activity-log" id="activityLog">
            <!-- Activity items will be loaded here -->
          </div>
          <div class="settings-actions">
            <button class="btn-reset" onclick="loadMoreActivity()">Load More</button>
            <button class="btn-reset" onclick="exportActivityLog()">üì• Export Log</button>
          </div>
        </div>
      </div>

      <!-- System Panel -->
      <div class="settings-panel" id="panel-system">
        <div class="settings-section">
          <h3>System Status</h3>
          <div class="status-cards">
            <div class="status-card">
              <div class="status-card-icon">üìä</div>
              <div class="status-card-value" id="totalRecords">-</div>
              <div class="status-card-label">Total Records</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">üíæ</div>
              <div class="status-card-value" id="dbSize">-</div>
              <div class="status-card-label">Database Size</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">üîÑ</div>
              <div class="status-card-value" id="lastSync">-</div>
              <div class="status-card-label">Last Sync</div>
            </div>
            <div class="status-card">
              <div class="status-card-icon">‚è±Ô∏è</div>
              <div class="status-card-value" id="uptime">-</div>
              <div class="status-card-label">Uptime</div>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Database Statistics</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--bg-alt); text-align: left;">
                <th style="padding: 10px;">Entity</th>
                <th style="padding: 10px;">Records</th>
                <th style="padding: 10px;">Last Updated</th>
              </tr>
            </thead>
            <tbody id="entityStats">
              <!-- Stats will be loaded here -->
            </tbody>
          </table>
        </div>

        <div class="settings-section">
          <h3>Maintenance</h3>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Clear Cache</div>
              <div class="setting-description">Clear browser cache and local storage</div>
            </div>
            <div class="setting-control">
              <button class="btn-reset" onclick="clearCache()">üóëÔ∏è Clear Cache</button>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Database Optimization</div>
              <div class="setting-description">Optimize database performance</div>
            </div>
            <div class="setting-control">
              <button class="btn-reset" onclick="optimizeDb()">‚ö° Optimize</button>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-info">
              <div class="setting-label">Reset All Settings</div>
              <div class="setting-description">Reset all settings to factory defaults</div>
            </div>
            <div class="setting-control">
              <button class="btn-reset" style="color: var(--danger); border-color: var(--danger);" onclick="factoryReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>System Information</h3>
          <div style="font-family: monospace; background: var(--bg-alt); padding: 16px; border-radius: 8px; font-size: 13px;">
            <div>Version: 2.0.0</div>
            <div>Build: 2024.01.15</div>
            <div>Environment: Production</div>
            <div>Database: <span id="dbType">-</span></div>
            <div>Node.js: <span id="nodeVersion">-</span></div>
          </div>
        </div>
      </div>
    </div><!-- End card -->
  </main>
</div><!-- End app -->

  <script src="/js/security-utils.js"></script>
  <script src="/js/ui-extras.js"></script>
  <script src="/js/toast.js"></script>
  <script src="/js/mobile-menu.js"></script>
  <script src="/js/auth-common.js?v=20260225"></script>
  <script src="/js/logout-handler.js?v=20260225"></script>
  <script src="/js/confirm-dialog.js"></script>
  <script>
    // Start token refresh system (uses window.startTokenRefresh from auth-common.js)
    if (window.startTokenRefresh) window.startTokenRefresh();
    
    // Initialize user info and auth check
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        const user = window.getUser();
        // Admin only page
        if (user.type !== 'admin') {
          window.location.href = '/single-dashboard.html';
          return;
        }
        document.getElementById('userName').textContent = user.name || user.username;
        document.getElementById('userRole').textContent = 'Administrator';
        
        // Load settings after auth verified
        loadSettings();
      } catch (e) {
        console.error('Auth error:', e);
        window.location.href = '/login.html';
      }
    });
  </script>
  <script>
    // Tab switching
    document.querySelectorAll('.settings-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
        
        tab.classList.add('active');
        const panelId = 'panel-' + tab.dataset.tab;
        document.getElementById(panelId).classList.add('active');
        
        // Load panel-specific data
        if (tab.dataset.tab === 'activity') loadActivityLog();
        if (tab.dataset.tab === 'system') loadSystemStats();
        if (tab.dataset.tab === 'users') loadUsers();
        if (tab.dataset.tab === 'regions') loadRegions();
        if (tab.dataset.tab === 'backup') loadBackups();
        if (tab.dataset.tab === 'email') checkEmailConfig();
      });
    });

    // ============ EMAIL CONFIGURATION STATUS ============
    async function checkEmailConfig() {
      const statusDiv = document.getElementById('emailConfigStatus');
      const statusIcon = document.getElementById('emailStatusIcon');
      const statusTitle = document.getElementById('emailStatusTitle');
      const statusMsg = document.getElementById('emailStatusMessage');
      
      if (!statusDiv) return;
      
      statusIcon.textContent = '‚è≥';
      statusTitle.textContent = 'Checking email configuration...';
      statusMsg.textContent = '';
      statusDiv.style.background = 'var(--bg-alt)';
      statusDiv.style.border = '1px solid var(--border-light)';
      
      try {
        const response = await fetchJson('/api/email/status');
        
        if (response.configured) {
          statusDiv.style.background = '#ecfdf5';
          statusDiv.style.border = '1px solid #10b981';
          statusIcon.textContent = '‚úÖ';
          statusTitle.textContent = 'Email Service Configured';
          statusMsg.textContent = 'SMTP is properly configured and ready to send emails.';
        } else {
          statusDiv.style.background = '#fef2f2';
          statusDiv.style.border = '1px solid #ef4444';
          statusIcon.textContent = '‚ùå';
          statusTitle.textContent = 'Email Not Configured';
          statusMsg.textContent = 'Set SMTP_USER and SMTP_PASSWORD environment variables on Render.';
        }
      } catch (err) {
        statusDiv.style.background = '#fef3c7';
        statusDiv.style.border = '1px solid #f59e0b';
        statusIcon.textContent = '‚ö†Ô∏è';
        statusTitle.textContent = 'Unable to check status';
        statusMsg.textContent = err.message || 'Could not connect to email status API';
      }
    }
    
    // ============ USER MANAGEMENT ============
    let allUsersData = [];
    let usersCurrentPage = 1;
    const usersPerPage = 10;
    
    async function loadUsers() {
      try {
        const users = await fetchJson('/api/users');
        
        // Try to get last login times from activity logs
        let loginTimes = {};
        try {
          const logs = await fetchJson('/api/activity_logs');
          logs.filter(l => l.action === 'LOGIN').forEach(log => {
            if (!loginTimes[log.username]) {
              loginTimes[log.username] = log.created_at;
            }
          });
        } catch (e) {
          console.warn('Could not load activity logs for last login times');
        }
        
        // Enrich users with last_login from activity logs and computed locked status
        allUsersData = users.map(u => ({
          ...u,
          last_login: loginTimes[u.username] || null,
          locked: u.locked_until && new Date(u.locked_until) > new Date()
        }));
        
        renderUsersTable();
        refreshUserStats();
      } catch (err) {
        console.error('Failed to load users:', err);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="7" style="text-align:center;padding:40px;color:#ef4444;">Failed to load users</td></tr>';
      }
    }
    
    function renderUsersTable() {
      const searchTerm = (document.getElementById('userSearchInput')?.value || '').toLowerCase();
      const typeFilter = document.getElementById('userTypeFilter')?.value || '';
      
      let filtered = allUsersData.filter(u => {
        const matchSearch = !searchTerm || 
          (u.username || '').toLowerCase().includes(searchTerm) ||
          (u.name || '').toLowerCase().includes(searchTerm) ||
          (u.email || '').toLowerCase().includes(searchTerm);
        const matchType = !typeFilter || u.type === typeFilter;
        return matchSearch && matchType;
      });
      
      const totalPages = Math.ceil(filtered.length / usersPerPage);
      const start = (usersCurrentPage - 1) * usersPerPage;
      const paged = filtered.slice(start, start + usersPerPage);
      
      const tbody = document.getElementById('usersTableBody');
      if (paged.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">No users found</td></tr>';
      } else {
        tbody.innerHTML = paged.map(u => `
          <tr>
            <td style="padding:12px;"><strong>${u.username}</strong></td>
            <td style="padding:12px;">${u.name || '-'}</td>
            <td style="padding:12px;">${u.email || '-'}</td>
            <td style="padding:12px;">
              <span style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;
                background:${u.type==='admin'?'#fef3c7':u.type==='semi-admin'?'#dbeafe':'#f3f4f6'};
                color:${u.type==='admin'?'#d97706':u.type==='semi-admin'?'#2563eb':'#6b7280'};">
                ${u.type}
              </span>
            </td>
            <td style="padding:12px;">
              <span style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;
                background:${u.locked?'#fee2e2':'#dcfce7'};color:${u.locked?'#dc2626':'#16a34a'};">
                ${u.locked ? 'Locked' : 'Active'}
              </span>
            </td>
            <td style="padding:12px;font-size:12px;color:var(--text-secondary);">
              ${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}
            </td>
            <td style="padding:12px;">
              <div style="display:flex;gap:6px;">
                <button onclick="editUserAdmin(${u.id})" style="padding:6px 10px;border:none;background:var(--bg-alt);border-radius:6px;cursor:pointer;" title="Edit">‚úèÔ∏è</button>
                ${u.locked ? 
                  `<button onclick="unlockUserAdmin(${u.id})" style="padding:6px 10px;border:none;background:#dcfce7;border-radius:6px;cursor:pointer;" title="Unlock">üîì</button>` :
                  `<button onclick="lockUserAdmin(${u.id})" style="padding:6px 10px;border:none;background:#fee2e2;border-radius:6px;cursor:pointer;" title="Lock">üîí</button>`
                }
                <button onclick="deleteUserAdmin(${u.id})" style="padding:6px 10px;border:none;background:#fee2e2;border-radius:6px;cursor:pointer;color:#dc2626;" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `).join('');
      }
      
      // Pagination
      const pagination = document.getElementById('usersPagination');
      if (totalPages <= 1) {
        pagination.innerHTML = '';
      } else {
        pagination.innerHTML = `
          <button ${usersCurrentPage===1?'disabled':''} onclick="usersCurrentPage=1;renderUsersTable()" style="padding:6px 12px;border:1px solid var(--border-light);border-radius:6px;cursor:pointer;">¬´</button>
          <button ${usersCurrentPage===1?'disabled':''} onclick="usersCurrentPage--;renderUsersTable()" style="padding:6px 12px;border:1px solid var(--border-light);border-radius:6px;cursor:pointer;">‚Äπ</button>
          <span style="padding:6px 12px;">Page ${usersCurrentPage} of ${totalPages}</span>
          <button ${usersCurrentPage===totalPages?'disabled':''} onclick="usersCurrentPage++;renderUsersTable()" style="padding:6px 12px;border:1px solid var(--border-light);border-radius:6px;cursor:pointer;">‚Ä∫</button>
          <button ${usersCurrentPage===totalPages?'disabled':''} onclick="usersCurrentPage=${totalPages};renderUsersTable()" style="padding:6px 12px;border:1px solid var(--border-light);border-radius:6px;cursor:pointer;">¬ª</button>
        `;
      }
    }
    
    // User search and filter
    document.getElementById('userSearchInput')?.addEventListener('input', () => { usersCurrentPage = 1; renderUsersTable(); });
    document.getElementById('userTypeFilter')?.addEventListener('change', () => { usersCurrentPage = 1; renderUsersTable(); });
    
    async function refreshUserStats() {
      try {
        const stats = await fetchJson('/api/system/stats');
        document.getElementById('statTotalUsersAdmin').textContent = stats.counts?.users || allUsersData.length;
        document.getElementById('statActiveUsersAdmin').textContent = stats.activeUsers24h || '-';
        document.getElementById('statLockedUsersAdmin').textContent = stats.lockedUsers || allUsersData.filter(u => u.locked_until).length;
        // Calculate total records from counts
        const totalRecords = Object.values(stats.counts || {}).reduce((a, b) => a + b, 0);
        document.getElementById('statTotalRecordsAdmin').textContent = totalRecords.toLocaleString();
      } catch (err) {
        document.getElementById('statTotalUsersAdmin').textContent = allUsersData.length;
        document.getElementById('statLockedUsersAdmin').textContent = allUsersData.filter(u => u.locked_until).length;
        document.getElementById('statActiveUsersAdmin').textContent = '-';
        document.getElementById('statTotalRecordsAdmin').textContent = '-';
      }
    }
    
    function showAddUserModal() {
      const modal = document.createElement('div');
      modal.id = 'userFormModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
      modal.innerHTML = `
        <div style="background:var(--card,#fff);border-radius:16px;width:90%;max-width:500px;max-height:90vh;overflow:auto;">
          <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">‚ûï Add New User</h3>
            <button onclick="document.getElementById('userFormModal').remove()" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <form id="addUserForm" style="padding:24px;">
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Username *</label>
              <input type="text" id="newUsername" required style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Name</label>
              <input type="text" id="newName" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Email</label>
              <input type="email" id="newEmail" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Password *</label>
              <input type="password" id="newPassword" required style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">User Type</label>
              <select id="newType" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
                <option value="basic">Basic</option>
                <option value="semi-admin">Semi Admin</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
              <button type="button" onclick="document.getElementById('userFormModal').remove()" style="padding:10px 20px;border:1px solid var(--border-light);background:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button type="submit" style="padding:10px 20px;border:none;background:var(--primary);color:white;border-radius:8px;cursor:pointer;">Add User</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await fetchJson('/api/users', {
            method: 'POST',
            body: JSON.stringify({
              username: document.getElementById('newUsername').value,
              name: document.getElementById('newName').value,
              email: document.getElementById('newEmail').value,
              password: document.getElementById('newPassword').value,
              type: document.getElementById('newType').value
            })
          });
          toast.success('User created successfully');
          document.getElementById('userFormModal').remove();
          loadUsers();
        } catch (err) {
          toast.error('Failed to create user: ' + (err.message || 'Error'));
        }
      });
    }
    
    async function editUserAdmin(id) {
      const user = allUsersData.find(u => u.id === id);
      if (!user) return;
      
      const modal = document.createElement('div');
      modal.id = 'userFormModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
      modal.innerHTML = `
        <div style="background:var(--card,#fff);border-radius:16px;width:90%;max-width:500px;max-height:90vh;overflow:auto;">
          <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">‚úèÔ∏è Edit User</h3>
            <button onclick="document.getElementById('userFormModal').remove()" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <form id="editUserForm" style="padding:24px;">
            <input type="hidden" id="editUserId" value="${user.id}">
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Username</label>
              <input type="text" id="editUsername" value="${user.username}" readonly style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;background:var(--bg-alt);">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Name</label>
              <input type="text" id="editName" value="${user.name || ''}" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Email</label>
              <input type="email" id="editEmail" value="${user.email || ''}" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">New Password (leave blank to keep)</label>
              <input type="password" id="editPassword" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">User Type</label>
              <select id="editType" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
                <option value="basic" ${user.type==='basic'?'selected':''}>Basic</option>
                <option value="semi-admin" ${user.type==='semi-admin'?'selected':''}>Semi Admin</option>
                <option value="admin" ${user.type==='admin'?'selected':''}>Admin</option>
              </select>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
              <button type="button" onclick="document.getElementById('userFormModal').remove()" style="padding:10px 20px;border:1px solid var(--border-light);background:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button type="submit" style="padding:10px 20px;border:none;background:var(--primary);color:white;border-radius:8px;cursor:pointer;">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
          name: document.getElementById('editName').value,
          email: document.getElementById('editEmail').value,
          type: document.getElementById('editType').value
        };
        const password = document.getElementById('editPassword').value;
        if (password) data.password = password;
        
        try {
          await fetchJson(`/api/users/${id}`, {
            method: 'PUT',
            body: JSON.stringify(data)
          });
          toast.success('User updated successfully');
          document.getElementById('userFormModal').remove();
          loadUsers();
        } catch (err) {
          toast.error('Failed to update user: ' + (err.message || 'Error'));
        }
      });
    }
    
    async function lockUserAdmin(id) {
      const user = allUsersData.find(u => u.id === id);
      if (!user) return;
      if (!confirm(`Lock user "${user.username}"? They will not be able to login.`)) return;
      try {
        await fetchJson(`/api/users/${user.username}/lock`, { method: 'POST' });
        toast.success('User locked');
        loadUsers();
      } catch (err) {
        toast.error('Failed to lock user: ' + (err.message || 'Error'));
      }
    }
    
    async function unlockUserAdmin(id) {
      const user = allUsersData.find(u => u.id === id);
      if (!user) return;
      try {
        await fetchJson(`/api/users/${user.username}/unlock`, { method: 'POST' });
        toast.success('User unlocked');
        loadUsers();
      } catch (err) {
        toast.error('Failed to unlock user: ' + (err.message || 'Error'));
      }
    }
    
    async function deleteUserAdmin(id) {
      const user = allUsersData.find(u => u.id === id);
      const currentUser = window.getUser ? window.getUser() : null;
      if (user && currentUser && user.username === currentUser.username) {
        toast.error('Cannot delete your own account');
        return;
      }
      if (!confirm('Delete this user? This cannot be undone.')) return;
      try {
        await fetchJson(`/api/users/${id}`, { method: 'DELETE' });
        toast.success('User deleted');
        loadUsers();
      } catch (err) {
        toast.error('Failed to delete user: ' + (err.message || 'Unknown error'));
      }
    }
    // ============ END USER MANAGEMENT ============

    // ============ REGIONS MANAGEMENT ============
    let allRegionsData = [];
    
    async function loadRegions() {
      try {
        const regions = await fetchJson('/api/regions');
        allRegionsData = regions || [];
        
        // Get sales counts per region
        let salesCounts = {};
        try {
          const sales = await fetchJson('/api/sales');
          sales.forEach(s => {
            if (s.region_id) {
              salesCounts[s.region_id] = (salesCounts[s.region_id] || 0) + 1;
            }
          });
        } catch (e) {
          console.warn('Could not load sales for region counts');
        }
        
        renderRegionsTable(salesCounts);
      } catch (err) {
        console.error('Failed to load regions:', err);
        document.getElementById('regionsTableBody').innerHTML = 
          '<tr><td colspan="5" style="text-align:center;padding:40px;color:#ef4444;">Failed to load regions</td></tr>';
      }
    }
    
    function renderRegionsTable(salesCounts = {}) {
      const searchTerm = (document.getElementById('regionSearchInput')?.value || '').toLowerCase();
      
      let filtered = allRegionsData.filter(r => {
        return !searchTerm || (r.region_name || '').toLowerCase().includes(searchTerm);
      });
      
      const tbody = document.getElementById('regionsTableBody');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-secondary);">No regions found. Click "Add Region" to create one.</td></tr>';
      } else {
        tbody.innerHTML = filtered.map(r => `
          <tr>
            <td style="padding:12px;">${r.id}</td>
            <td style="padding:12px;"><strong>${r.region_name || '-'}</strong></td>
            <td style="padding:12px;">${r.description || '-'}</td>
            <td style="padding:12px;">${salesCounts[r.id] || 0}</td>
            <td style="padding:12px;">
              <div style="display:flex;gap:6px;">
                <button onclick="editRegion(${r.id})" style="padding:6px 10px;border:none;background:var(--bg-alt);border-radius:6px;cursor:pointer;" title="Edit">‚úèÔ∏è</button>
                <button onclick="deleteRegion(${r.id})" style="padding:6px 10px;border:none;background:#fee2e2;border-radius:6px;cursor:pointer;color:#dc2626;" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `).join('');
      }
    }
    
    // Region search listener
    document.getElementById('regionSearchInput')?.addEventListener('input', () => renderRegionsTable());
    
    function showAddRegionModal() {
      const modal = document.createElement('div');
      modal.id = 'regionFormModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
      modal.innerHTML = `
        <div style="background:var(--card,#fff);border-radius:16px;width:90%;max-width:450px;max-height:90vh;overflow:auto;">
          <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">üåç Add New Region</h3>
            <button onclick="document.getElementById('regionFormModal').remove()" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <form id="addRegionForm" style="padding:24px;">
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Region Name *</label>
              <input type="text" id="newRegionName" required style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;" placeholder="e.g., Asia Pacific">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Description</label>
              <textarea id="newRegionDesc" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;min-height:80px;" placeholder="Optional description"></textarea>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
              <button type="button" onclick="document.getElementById('regionFormModal').remove()" style="padding:10px 20px;border:1px solid var(--border-light);background:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button type="submit" style="padding:10px 20px;border:none;background:var(--primary);color:white;border-radius:8px;cursor:pointer;">Add Region</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('addRegionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await fetchJson('/api/regions', {
            method: 'POST',
            body: JSON.stringify({
              region_name: document.getElementById('newRegionName').value,
              description: document.getElementById('newRegionDesc').value
            })
          });
          toast.success('Region created successfully');
          document.getElementById('regionFormModal').remove();
          loadRegions();
        } catch (err) {
          toast.error('Failed to create region: ' + (err.message || 'Error'));
        }
      });
    }
    
    async function editRegion(id) {
      const region = allRegionsData.find(r => r.id === id);
      if (!region) return;
      
      const modal = document.createElement('div');
      modal.id = 'regionFormModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;';
      modal.innerHTML = `
        <div style="background:var(--card,#fff);border-radius:16px;width:90%;max-width:450px;max-height:90vh;overflow:auto;">
          <div style="padding:20px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;">‚úèÔ∏è Edit Region</h3>
            <button onclick="document.getElementById('regionFormModal').remove()" style="border:none;background:none;font-size:24px;cursor:pointer;">&times;</button>
          </div>
          <form id="editRegionForm" style="padding:24px;">
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Region Name *</label>
              <input type="text" id="editRegionName" value="${region.region_name || ''}" required style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;">
            </div>
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:6px;font-weight:500;">Description</label>
              <textarea id="editRegionDesc" style="width:100%;padding:10px;border:1px solid var(--border-light);border-radius:8px;min-height:80px;">${region.description || ''}</textarea>
            </div>
            <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
              <button type="button" onclick="document.getElementById('regionFormModal').remove()" style="padding:10px 20px;border:1px solid var(--border-light);background:none;border-radius:8px;cursor:pointer;">Cancel</button>
              <button type="submit" style="padding:10px 20px;border:none;background:var(--primary);color:white;border-radius:8px;cursor:pointer;">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      
      document.getElementById('editRegionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await fetchJson(`/api/regions/${id}`, {
            method: 'PUT',
            body: JSON.stringify({
              region_name: document.getElementById('editRegionName').value,
              description: document.getElementById('editRegionDesc').value
            })
          });
          toast.success('Region updated successfully');
          document.getElementById('regionFormModal').remove();
          loadRegions();
        } catch (err) {
          toast.error('Failed to update region: ' + (err.message || 'Error'));
        }
      });
    }
    
    async function deleteRegion(id) {
      const region = allRegionsData.find(r => r.id === id);
      if (!confirm(`Delete region "${region?.region_name}"? This cannot be undone.`)) return;
      try {
        await fetchJson(`/api/regions/${id}`, { method: 'DELETE' });
        toast.success('Region deleted');
        loadRegions();
      } catch (err) {
        toast.error('Failed to delete region: ' + (err.message || 'Error'));
      }
    }
    // ============ END REGIONS MANAGEMENT ============

    // Product types for margin benchmarks
    const PRODUCT_TYPES = [
      { id: 'flight', name: 'Flight', icon: '‚úàÔ∏è' },
      { id: 'hotel', name: 'Hotel', icon: 'üè®' },
      { id: 'tour', name: 'Tour', icon: 'üß≥' },
      { id: 'package', name: 'Package', icon: 'üì¶' },
      { id: 'cruise', name: 'Cruise', icon: 'üö¢' },
      { id: 'admission', name: 'Admission', icon: 'üé´' },
      { id: 'passport', name: 'Passport', icon: 'üõÇ' },
      { id: 'visa', name: 'Visa', icon: 'üìã' },
      { id: 'insurance', name: 'Insurance', icon: 'üõ°Ô∏è' },
      { id: 'train', name: 'Train', icon: 'üöÜ' },
      { id: 'other', name: 'Other', icon: 'üìù' }
    ];

    // Load saved settings from API (with localStorage fallback)
    async function loadSettings() {
      let settings = {};
      
      // Try to load from API first
      try {
        settings = await fetchJson('/api/settings') || {};
        // Cache in localStorage for offline/faster access
        localStorage.setItem('appSettings', JSON.stringify(settings));
      } catch (err) {
        console.warn('Failed to load settings from API, using localStorage:', err);
        settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
      }
      
      applySettingsToUI(settings);
    }
    
    function applySettingsToUI(settings) {
      if (settings.companyName) document.getElementById('companyName').value = settings.companyName;
      if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
      if (settings.currency) document.getElementById('currency').value = settings.currency;
      if (settings.itemsPerPage) document.getElementById('itemsPerPage').value = settings.itemsPerPage;
      if (settings.animations !== undefined) document.getElementById('animations').checked = settings.animations;
      if (settings.autoRefresh) document.getElementById('autoRefresh').value = settings.autoRefresh;
      if (settings.soundNotifications) document.getElementById('soundNotifications').checked = settings.soundNotifications;
      
      // Load default margin benchmark settings
      const marginHighEl = document.getElementById('marginHighThreshold');
      const marginMediumEl = document.getElementById('marginMediumThreshold');
      if (marginHighEl) marginHighEl.value = settings.marginHighThreshold ?? 20;
      if (marginMediumEl) marginMediumEl.value = settings.marginMediumThreshold ?? 10;
      
      // Render per-product margin table
      renderProductMarginTable(settings);
      
    }
    
    function renderProductMarginTable(settings) {
      const tbody = document.getElementById('productMarginTable');
      if (!tbody) return;
      
      const productMargins = settings.productMargins || {};
      const defaultHigh = settings.marginHighThreshold ?? 20;
      const defaultMedium = settings.marginMediumThreshold ?? 10;
      
      tbody.innerHTML = PRODUCT_TYPES.map(p => {
        const pm = productMargins[p.id] || {};
        const useDefault = pm.useDefault !== false; // Default to true
        const high = pm.high ?? defaultHigh;
        const medium = pm.medium ?? defaultMedium;
        
        return `
          <tr>
            <td>
              <span style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">${p.icon}</span>
                <strong>${p.name}</strong>
              </span>
            </td>
            <td style="text-align: center;">
              <input type="number" id="pm_high_${p.id}" min="0" max="100" step="0.1" value="${high}" 
                     style="width: 80px; text-align: center;" ${useDefault ? 'disabled' : ''}>
            </td>
            <td style="text-align: center;">
              <input type="number" id="pm_medium_${p.id}" min="0" max="100" step="0.1" value="${medium}" 
                     style="width: 80px; text-align: center;" ${useDefault ? 'disabled' : ''}>
            </td>
            <td style="text-align: center;">
              <label class="toggle-switch" style="margin: 0 auto; display: block; width: 48px;">
                <input type="checkbox" id="pm_default_${p.id}" ${useDefault ? 'checked' : ''} 
                       onchange="toggleProductMargin('${p.id}', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function toggleProductMargin(productId, useDefault) {
      const highInput = document.getElementById(`pm_high_${productId}`);
      const mediumInput = document.getElementById(`pm_medium_${productId}`);
      
      if (useDefault) {
        // Copy default values
        const defaultHigh = document.getElementById('marginHighThreshold')?.value || 20;
        const defaultMedium = document.getElementById('marginMediumThreshold')?.value || 10;
        highInput.value = defaultHigh;
        mediumInput.value = defaultMedium;
        highInput.disabled = true;
        mediumInput.disabled = true;
      } else {
        highInput.disabled = false;
        mediumInput.disabled = false;
      }
    }

    async function saveGeneralSettings() {
      const marginHigh = parseFloat(document.getElementById('marginHighThreshold')?.value) || 20;
      const marginMedium = parseFloat(document.getElementById('marginMediumThreshold')?.value) || 10;
      
      // Validate margin thresholds
      if (marginMedium >= marginHigh) {
        toast.warning('Medium threshold must be lower than High threshold');
        return;
      }
      
      // Collect per-product margin settings
      const productMargins = {};
      let hasInvalidProduct = false;
      
      PRODUCT_TYPES.forEach(p => {
        const useDefault = document.getElementById(`pm_default_${p.id}`)?.checked ?? true;
        const high = parseFloat(document.getElementById(`pm_high_${p.id}`)?.value) || marginHigh;
        const medium = parseFloat(document.getElementById(`pm_medium_${p.id}`)?.value) || marginMedium;
        
        if (!useDefault && medium >= high) {
          toast.warning(`${p.name}: Medium threshold must be lower than High threshold`);
          hasInvalidProduct = true;
        }
        
        productMargins[p.id] = {
          useDefault,
          high: useDefault ? marginHigh : high,
          medium: useDefault ? marginMedium : medium
        };
      });
      
      if (hasInvalidProduct) return;
      
      const settings = {
        companyName: document.getElementById('companyName').value,
        dateFormat: document.getElementById('dateFormat').value,
        currency: document.getElementById('currency').value,
        itemsPerPage: document.getElementById('itemsPerPage').value,
        animations: document.getElementById('animations').checked,
        autoRefresh: document.getElementById('autoRefresh').value,
        soundNotifications: document.getElementById('soundNotifications').checked,
        marginHighThreshold: marginHigh,
        marginMediumThreshold: marginMedium,
        productMargins: productMargins
      };
      
      console.log('üíæ Saving settings:', settings);
      
      // Save to API (database)
      try {
        await fetchJson('/api/settings', {
          method: 'PUT',
          body: JSON.stringify(settings)
        });
        console.log('‚úÖ Settings saved to database');
      } catch (err) {
        console.error('‚ùå Failed to save settings to API:', err);
        toast.error('Failed to save settings to server. Changes saved locally only.');
      }
      
      // Also save to localStorage for faster loading/offline
      localStorage.setItem('appSettings', JSON.stringify(settings));
      
      toast.success('Settings saved successfully!');
    }

    function resetGeneralSettings() {
      if (confirm('Reset all settings to default?')) {
        localStorage.removeItem('appSettings');
        location.reload();
      }
    }

    async function testEmail() {
      const email = document.getElementById('testEmailAddress').value;
      const resultDiv = document.getElementById('testEmailResult');
      
      if (!email) {
        toast.warning('Please enter an email address');
        return;
      }
      
      toast.info('Sending test email...');
      try {
        const response = await fetchJson('/api/email/test', {
          method: 'POST',
          body: { email }
        });
        
        if (response.success) {
          toast.success('Test email sent! Check your inbox.');
          if (resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #ecfdf5; border-radius: 8px; border: 1px solid #10b981;">
                <strong style="color: #065f46;">‚úÖ Test email sent successfully!</strong>
                <p style="margin: 8px 0 0 0; color: #047857; font-size: 0.9rem;">
                  Check ${email} for the test message.
                </p>
              </div>
            `;
          }
        } else {
          toast.error(response.error || 'Failed to send test email');
          if (resultDiv) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
              <div style="padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #ef4444;">
                <strong style="color: #991b1b;">‚ùå Failed to send test email</strong>
                <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 0.9rem;">
                  ${response.error || 'Unknown error'}
                </p>
              </div>
            `;
          }
        }
      } catch (err) {
        toast.error('Failed to send test email: ' + (err.message || 'Server error'));
        if (resultDiv) {
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = `
            <div style="padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #ef4444;">
              <strong style="color: #991b1b;">‚ùå Failed to send test email</strong>
              <p style="margin: 8px 0 0 0; color: #b91c1c; font-size: 0.9rem;">
                ${err.message || 'Server error'}
              </p>
            </div>
          `;
        }
      }
    }

    async function triggerReminders() {
      if (!confirm('This will send departure reminder emails for all upcoming tours. Continue?')) return;
      
      toast.info('Triggering reminders...');
      try {
        const response = await fetchJson('/api/email/trigger-reminders', {
          method: 'POST'
        });
        
        if (response.success) {
          toast.success(`Reminders sent: ${response.remindersSent}, Errors: ${response.errors}`);
        } else {
          toast.error(response.error || 'Failed to trigger reminders');
        }
      } catch (err) {
        toast.error('Failed to trigger reminders: ' + (err.message || 'Server error'));
      }
    }

    async function loadReminderStats() {
      const panel = document.getElementById('reminderStatsPanel');
      const content = document.getElementById('reminderStatsContent');
      
      panel.style.display = 'block';
      content.innerHTML = 'Loading...';
      
      try {
        const response = await fetchJson('/api/email/reminder-stats');
        const stats = response.stats || {};
        
        content.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
            <div style="text-align: center; padding: 12px; background: var(--card); border-radius: 6px;">
              <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${stats.totalSent || 0}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Total Sent</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--card); border-radius: 6px;">
              <div style="font-size: 24px; font-weight: bold; color: var(--success);">${stats.upcomingTours || 0}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Upcoming Tours</div>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--card); border-radius: 6px;">
              <div style="font-size: 24px; font-weight: bold; color: var(--warning);">${stats.pendingReminders || 0}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Pending Reminders</div>
            </div>
          </div>
          <div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
            Last updated: ${new Date().toLocaleString()}
          </div>
        `;
      } catch (err) {
        content.innerHTML = '<div style="color: var(--danger);">Failed to load statistics</div>';
      }
    }

    async function createBackup() {
      toast.info('Creating backup...');
      
      try {
        const response = await fetchJson('/api/backup', { method: 'POST' });
        if (response.ok) {
          toast.success('Server backup created: ' + (response.file || 'backup.db'));
          loadBackups(); // Refresh the backup list
        } else {
          throw new Error(response.error);
        }
      } catch (err) {
        // Fallback: create client-side data export
        toast.info('Server backup unavailable, creating data export...');
        try {
          const entities = ['sales', 'tours', 'documents', 'targets', 'hotel_bookings', 'cruise', 'telecom'];
          const exportData = {
            timestamp: new Date().toISOString(),
            version: '2.0.0',
            settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
            data: {}
          };
          
          for (const entity of entities) {
            try {
              const data = await fetchJson(`/api/${entity}`);
              exportData.data[entity] = Array.isArray(data) ? data : [];
            } catch (e) {
              exportData.data[entity] = [];
            }
          }
          
          const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `travelops_backup_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          toast.success('Data export downloaded!');
        } catch (exportErr) {
          toast.error('Backup failed: ' + exportErr.message);
        }
      }
    }

    // Load and display available backups
    async function loadBackups() {
      const backupList = document.getElementById('backupList');
      if (!backupList) return;
      
      backupList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);">Loading backups...</div>';
      
      try {
        const response = await fetchJson('/api/backups');
        const backups = response.backups || [];
        
        if (backups.length === 0) {
          backupList.innerHTML = `
            <div style="text-align:center;padding:40px;color:var(--text-secondary);">
              <div style="font-size:48px;margin-bottom:12px;">üì¶</div>
              <div>No backups found</div>
              <div style="font-size:13px;margin-top:8px;">Click "Create Backup Now" to create your first backup</div>
            </div>
          `;
          return;
        }
        
        backupList.innerHTML = backups.map(backup => `
          <div class="backup-item">
            <div class="backup-info">
              <span class="backup-icon">${backup.filename.endsWith('.json') ? 'üìÑ' : 'üíæ'}</span>
              <div>
                <div class="backup-name">${backup.filename}</div>
                <div class="backup-date">${backup.createdFormatted} ‚Ä¢ ${backup.sizeFormatted}</div>
              </div>
            </div>
            <div class="backup-actions">
              <button class="btn-download" onclick="downloadBackup('${backup.filename}')">‚¨áÔ∏è Download</button>
              <button class="btn-delete-backup" onclick="deleteBackup('${backup.filename}')">üóëÔ∏è Delete</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        backupList.innerHTML = `
          <div style="text-align:center;padding:40px;color:var(--danger);">
            <div style="font-size:48px;margin-bottom:12px;">‚ö†Ô∏è</div>
            <div>Failed to load backups</div>
            <div style="font-size:13px;margin-top:8px;">${err.message || 'Check server connection'}</div>
          </div>
        `;
      }
    }

    // Download a backup file
    async function downloadBackup(filename) {
      toast.info('Downloading backup...');
      try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/backups/${encodeURIComponent(filename)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Download failed');
        }
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        
        toast.success('Backup downloaded!');
      } catch (err) {
        toast.error('Download failed: ' + err.message);
      }
    }

    // Delete a backup file
    async function deleteBackup(filename) {
      if (!confirm(`Delete backup "${filename}"? This cannot be undone.`)) return;
      
      toast.info('Deleting backup...');
      try {
        await fetchJson(`/api/backups/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        toast.success('Backup deleted');
        loadBackups(); // Refresh the list
      } catch (err) {
        toast.error('Delete failed: ' + err.message);
      }
    }

    // Import/Export functionality
    async function importData() {
      const fileInput = document.getElementById('importFile');
      const entity = document.querySelector('input[name="importEntity"]:checked')?.value;
      
      if (!fileInput.files[0]) {
        toast.warning('Please select a file to import');
        return;
      }
      
      if (!entity) {
        toast.warning('Please select an entity type');
        return;
      }
      
      const file = fileInput.files[0];
      toast.info(`Importing ${entity} data...`);
      
      try {
        const content = await file.text();
        let data = [];
        
        if (file.name.endsWith('.csv')) {
          // Parse CSV
          const lines = content.split('\n').filter(l => l.trim());
          if (lines.length < 2) {
            throw new Error('CSV file is empty or has no data rows');
          }
          const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const row = {};
            headers.forEach((h, idx) => {
              row[h] = values[idx] || '';
            });
            data.push(row);
          }
        } else if (file.name.endsWith('.json')) {
          const parsed = JSON.parse(content);
          data = Array.isArray(parsed) ? parsed : (parsed.data || []);
        } else {
          throw new Error('Unsupported file format. Use CSV or JSON.');
        }
        
        if (data.length === 0) {
          throw new Error('No data found in file');
        }
        
        const response = await fetchJson(`/api/import/${entity}`, {
          method: 'POST',
          body: JSON.stringify({ data })
        });
        
        if (response.ok) {
          toast.success(`Imported ${response.imported} records (${response.failed} failed)`);
          fileInput.value = '';
          document.querySelector('#importDropzone .dropzone-text').textContent = 'Drop CSV file here';
        } else {
          throw new Error(response.error || 'Import failed');
        }
      } catch (err) {
        toast.error('Import failed: ' + err.message);
      }
    }

    async function exportData() {
      const selected = Array.from(document.querySelectorAll('input[name="exportEntity"]:checked'))
        .map(cb => cb.value);
      const format = document.getElementById('exportFormat').value;
      
      if (selected.length === 0) {
        toast.warning('Please select at least one entity to export');
        return;
      }
      
      toast.info('Preparing export...');
      
      try {
        // Use export endpoint if available, else fall back to fetching data
        const exportData = {};
        
        for (const entity of selected) {
          try {
            const data = await fetchJson(`/api/export/${entity}?format=json`);
            exportData[entity] = Array.isArray(data) ? data : [];
          } catch (e) {
            // Fallback to regular endpoint
            const data = await fetchJson(`/api/${entity}`);
            exportData[entity] = Array.isArray(data) ? data : [];
          }
        }
        
        let content, filename, type;
        
        if (format === 'json') {
          content = JSON.stringify(exportData, null, 2);
          filename = `export_${new Date().toISOString().split('T')[0]}.json`;
          type = 'application/json';
        } else {
          // Convert to CSV (first entity only for simplicity)
          const firstEntity = selected[0];
          const data = exportData[firstEntity];
          if (Array.isArray(data) && data.length > 0) {
            const headers = Object.keys(data[0]);
            const escapeCSV = (val) => {
              if (val === null || val === undefined) return '';
              const str = String(val);
              if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
              }
              return str;
            };
            const rows = data.map(item => headers.map(h => escapeCSV(item[h])).join(','));
            content = [headers.join(','), ...rows].join('\n');
          } else {
            content = '';
          }
          filename = `export_${firstEntity}_${new Date().toISOString().split('T')[0]}.csv`;
          type = 'text/csv';
        }
        
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        
        toast.success('Export complete!');
      } catch (err) {
        toast.error('Export failed: ' + err.message);
      }
    }

    // Activity Log
    let activityPage = 1;
    
    async function loadActivityLog() {
      try {
        const data = await fetchJson('/api/activity_logs');
        const container = document.getElementById('activityLog');
        
        if (!data || data.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">No activity logs found</div>';
          return;
        }
        
        container.innerHTML = data.map(log => `
          <div class="activity-item">
            <div class="activity-icon">${getActivityIcon(log.action)}</div>
            <div class="activity-content">
              <div class="activity-message">
                <strong>${log.username || 'System'}</strong> ${log.action} ${log.entity_type} 
                ${log.entity_id ? `#${log.entity_id}` : ''}
                ${log.details ? `<br><small style="color: var(--text-secondary);">${log.details}</small>` : ''}
              </div>
              <div class="activity-time">${formatDate(log.created_at)}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('activityLog').innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            Unable to load activity logs: ${err.message || 'Error'}
          </div>
        `;
      }
    }

    function getActivityIcon(action) {
      const icons = {
        'CREATE': '‚ûï',
        'UPDATE': '‚úèÔ∏è',
        'DELETE': 'üóëÔ∏è',
        'LOGIN': 'üîë',
        'LOGOUT': 'üö™',
        'EXPORT': 'üì§',
        'IMPORT': 'üì•'
      };
      return icons[action?.toUpperCase()] || 'üìù';
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString();
    }

    function filterActivity() {
      activityPage = 1;
      loadActivityLog();
    }

    function loadMoreActivity() {
      activityPage++;
      // Append more items
    }

    function exportActivityLog() {
      toast.info('Exporting activity log...');
      // Export logic
    }

    // System Stats
    async function loadSystemStats() {
      try {
        const data = await fetchJson('/api/system/stats');
        
        // Calculate total records from counts
        const totalRecords = Object.values(data.counts || {}).reduce((a, b) => a + b, 0);
        document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
        document.getElementById('dbSize').textContent = data.database?.sizeMB ? `${data.database.sizeMB} MB` : '-';
        document.getElementById('lastSync').textContent = 'Just now';
        
        // Format uptime properly
        const uptimeSeconds = data.uptime || 0;
        document.getElementById('uptime').textContent = formatUptime(uptimeSeconds);
        
        document.getElementById('dbType').textContent = data.database?.dialect?.toUpperCase() || 'SQLite';
        document.getElementById('nodeVersion').textContent = data.nodeVersion || process.version || '-';
        
        // Entity stats from counts
        if (data.counts) {
          const entityLabels = {
            users: 'Users',
            sales: 'Sales',
            tours: 'Tours',
            documents: 'Documents',
            targets: 'Targets',
            telecom: 'Telecom',
            hotel_bookings: 'Hotel Bookings',
            regions: 'Regions',
            productivity: 'Productivity',
            overtime: 'Overtime',
            outstanding: 'Outstanding',
            cruise: 'Cruise',
            cashout: 'Cash Out',
            activity_logs: 'Activity Logs'
          };
          document.getElementById('entityStats').innerHTML = Object.entries(data.counts)
            .filter(([entity]) => entity !== 'activity_logs')
            .map(([entity, count]) => `
              <tr>
                <td style="padding: 10px; border-bottom: 1px solid var(--border-light);">
                  ${entityLabels[entity] || entity}
                </td>
                <td style="padding: 10px; border-bottom: 1px solid var(--border-light);">
                  ${count?.toLocaleString() || 0}
                </td>
                <td style="padding: 10px; border-bottom: 1px solid var(--border-light);">-</td>
              </tr>
            `).join('');
        }
        
        // Show additional system info if available
        if (data.activeUsers24h !== undefined || data.lockedUsers !== undefined) {
          const additionalInfo = [];
          if (data.activeUsers24h !== undefined) additionalInfo.push(`Active users (24h): ${data.activeUsers24h}`);
          if (data.lockedUsers !== undefined) additionalInfo.push(`Locked accounts: ${data.lockedUsers}`);
          if (data.recentActivity7d !== undefined) additionalInfo.push(`Recent activity (7d): ${data.recentActivity7d}`);
          
          const sysInfo = document.querySelector('.settings-section:last-child div[style*="monospace"]');
          if (sysInfo && additionalInfo.length > 0) {
            additionalInfo.forEach(info => {
              const div = document.createElement('div');
              div.textContent = info;
              sysInfo.appendChild(div);
            });
          }
        }
      } catch (err) {
        console.error('Failed to load system stats:', err);
        document.getElementById('totalRecords').textContent = '-';
        document.getElementById('dbSize').textContent = '-';
        document.getElementById('uptime').textContent = '-';
      }
    }
    
    function formatUptime(seconds) {
      if (!seconds || seconds <= 0) return '-';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      
      if (days > 0) return `${days}d ${hours}h ${mins}m`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }

    function clearCache() {
      if (confirm('Clear all cached data? This will not affect your saved data.')) {
        localStorage.removeItem('filterPresets');
        localStorage.removeItem('searchHistory');
        localStorage.removeItem('tableConfig');
        
        if ('caches' in window) {
          caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
          });
        }
        
        toast.success('Cache cleared!');
      }
    }

    async function optimizeDb() {
      toast.info('Optimizing database...');
      try {
        // For SQLite, VACUUM command optimizes
        await fetchJson('/api/system/optimize', { method: 'POST' });
        toast.success('Database optimized!');
      } catch (err) {
        // If no optimize endpoint, just clear local cache
        if ('caches' in window) {
          const names = await caches.keys();
          await Promise.all(names.map(name => caches.delete(name)));
        }
        toast.success('Local cache optimized!');
      }
    }

    function factoryReset() {
      if (confirm('‚ö†Ô∏è WARNING: This will reset ALL settings to defaults. This cannot be undone. Continue?')) {
        if (confirm('Are you absolutely sure?')) {
          localStorage.clear();
          toast.success('Factory reset complete. Reloading...');
          setTimeout(() => location.reload(), 1500);
        }
      }
    }

    // Dropzone handlers
    function setupDropzone(dropzoneId, fileInputId) {
      const dropzone = document.getElementById(dropzoneId);
      const fileInput = document.getElementById(fileInputId);
      
      if (!dropzone || !fileInput) return;
      
      dropzone.addEventListener('click', () => fileInput.click());
      
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          dropzone.querySelector('.dropzone-text').textContent = files[0].name;
        }
      });
      
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          dropzone.querySelector('.dropzone-text').textContent = fileInput.files[0].name;
        }
      });
    }

    // Initialize dropzones (settings loaded from module script above)
    document.addEventListener('DOMContentLoaded', () => {
      setupDropzone('importDropzone', 'importFile');
      setupDropzone('restoreDropzone', 'restoreFile');
    });
    
    // ===================================================================
    // ACTIVE SESSIONS MANAGEMENT
    // ===================================================================
    async function loadActiveSessions() {
      try {
        const data = await fetchJson('/api/sessions/active');
        const tbody = document.getElementById('sessionsTableBody');
        const countEl = document.getElementById('activeSessionCount');
        
        if (countEl) countEl.textContent = data.count || 0;
        
        if (!data.sessions || data.sessions.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">No active sessions</td></tr>`;
          return;
        }
        
        tbody.innerHTML = data.sessions.map(session => {
          const loginTime = new Date(session.loginTime).toLocaleString();
          const roleColors = {
            'admin': '#ef4444',
            'semi-admin': '#f59e0b',
            'basic': '#3b82f6'
          };
          const roleColor = roleColors[session.type] || '#6b7280';
          
          return `
            <tr>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-light);">
                <div style="font-weight: 600;">${session.name || session.username}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">@${session.username}</div>
              </td>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-light);">
                <span style="background: ${roleColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                  ${session.type}
                </span>
              </td>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-light);">${loginTime}</td>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-light);">
                <span style="font-family: monospace; font-size: 13px;">${session.deviceInfo?.ip || 'Unknown'}</span>
              </td>
              <td style="padding: 12px; border-bottom: 1px solid var(--border-light);">
                <button onclick="terminateSession(${session.userId}, '${session.username}')" 
                        class="btn-action delete" 
                        style="padding: 6px 12px; font-size: 12px; border-radius: 5px; cursor: pointer; background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5;">
                  üö´ Terminate
                </button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (err) {
        console.error('Failed to load active sessions:', err);
        document.getElementById('sessionsTableBody').innerHTML = `
          <tr><td colspan="5" style="text-align: center; padding: 40px; color: #dc2626;">Failed to load sessions</td></tr>
        `;
      }
    }
    
    async function terminateSession(userId, username) {
      if (!confirm(`Terminate session for "${username}"? They will be logged out immediately.`)) {
        return;
      }
      
      try {
        await fetchJson(`/api/sessions/${userId}/terminate`, { method: 'POST' });
        toast.success(`Session for ${username} has been terminated`);
        loadActiveSessions(); // Refresh the list
      } catch (err) {
        console.error('Failed to terminate session:', err);
        toast.error('Failed to terminate session');
      }
    }
    
    // Load sessions when tab is activated
    document.addEventListener('DOMContentLoaded', () => {
      const sessionsTab = document.querySelector('[data-tab="sessions"]');
      if (sessionsTab) {
        sessionsTab.addEventListener('click', loadActiveSessions);
      }
    });
  </script>
<script src="/js/sidebar-enhancements.js?v=20251215"></script>
<script src="/js/keyboard-shortcuts.js?v=20251215"></script>
<script src="/js/sidebar-groups.js"></script>
<script src="/js/error-monitoring.js"></script>
<script src="/js/api-cache.js"></script>
<script src="/js/breadcrumb-nav.js"></script>
<script src="/js/lazy-loader.js"></script>
</body>
</html>
