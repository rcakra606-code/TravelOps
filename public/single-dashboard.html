<!doctype html>
<html lang="id">
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TravelOps web</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css" />
<link rel="stylesheet" href="/css/styles.css">
<link rel="stylesheet" href="/css/modal.css">
<link rel="stylesheet" href="/css/dashboard.css">
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">üöÄ TravelOps</div>
    <div class="nav" id="mainNav">
      <button data-section="summary" class="active">üè† Dashboard</button>
      <button data-section="sales">üí∞ Sales</button>
      <button data-section="tours">üß≥ Tours</button>
      <button data-section="documents">üìÑ Documents</button>
      <button data-section="targets">üéØ Targets</button>
      <button data-section="telecom">üìû Telecom</button>
      <button data-section="regions">üåç Regions</button>
      <button data-section="users">üë• Users</button>
  <button data-section="profile">‚öôÔ∏è Profile</button>
  <a id="logoutLink" href="/logout.html">üö™ Logout</a>
    </div>
    <div class="userbox" style="margin-top:18px">
      <div id="userName">‚Äî</div>
      <div id="userRole">‚Äî</div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h2 id="pageTitle">Dashboard</h2>
        <div class="small" id="pageSubtitle">Ringkasan operasional</div>
      </div>
      <div class="controls">
        <div class="filter-row" style="margin:0">
          <label class="small">Staff:</label>
          <select id="filterStaff"><option value="all">Semua</option></select>
          <label class="small">Periode:</label>
          <select id="filterPeriod"><option value="all">Keseluruhan</option><option value="month">Per Bulan</option><option value="year">Per Tahun</option></select>
          <input id="filterMonth" type="month" style="display:none">
          <input id="filterYear" type="number" placeholder="Tahun" min="2000" max="2100" style="width:100px;display:none">
          <label class="small">Region:</label>
          <select id="filterRegion"><option value="all">Semua</option></select>
          <button id="applyFilters" class="btn">Terapkan</button>
        </div>
      </div>
    </div>

   <section id="summary" class="card section active">
  <!-- === METRICS TOP ROW === -->

<!-- === GLOBAL FILTER === -->
<!-- Removed obsolete global filter bar; per-entity modal filtering now in use -->

  <div class="dashboard-metrics">
    <div class="metric-card" id="metricSales">
      <div class="metric-title">Sales</div>
      <div class="metric-value" id="totalSales">Rp 0</div>
      <div class="metric-subtitle" id="salesAchievement">-</div>
    </div>

    <div class="metric-card" id="metricProfit">
      <div class="metric-title">Profit</div>
      <div class="metric-value" id="totalProfit">Rp 0</div>
      <div class="metric-subtitle" id="profitAchievement">-</div>
    </div>

    <div class="metric-card" id="metricParticipants">
      <div class="metric-title">Total Peserta</div>
      <div class="metric-value" id="totalParticipants">0</div>
      <div class="metric-subtitle">Per bulan / per region di bawah</div>
    </div>

    <div class="metric-card" id="metricDocs">
      <div class="metric-title">Dokumen Masuk</div>
      <div class="metric-value" id="totalDocs">0</div>
      <div class="metric-subtitle">Per proses & per region di bawah</div>
    </div>

    <div style="text-align:right; margin-bottom:10px;">
     <button id="exportDashboardCSV" class="btn">‚¨á Export Dashboard CSV</button>
    </div>
  </div>

  <!-- === SALES / PROFIT CHARTS === -->
  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Sales vs Target Sales</div>
    </div>
    <canvas id="chartSalesTarget" class="chart-sales-target"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Profit vs Target Profit</div>
    </div>
    <canvas id="chartProfitTarget" class="chart-profit-target"></canvas>
  </div>

  <!-- === PESERTA === -->
  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Peserta per Bulan Keberangkatan</div>
    </div>
    <canvas id="chartParticipantMonth" class="chart-participants"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Peserta per Region</div>
    </div>
    <canvas id="chartParticipantRegion" class="chart-participants"></canvas>
  </div>

  <!-- === DOKUMEN === -->
  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Dokumen ‚Äî by Process (Normal vs Kilat)</div>
    </div>
    <canvas id="chartDocType" class="chart-documents"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Dokumen ‚Äî by Region</div>
    </div>
    <canvas id="chartDocsRegion" class="chart-documents"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-header">
      <div class="chart-title">Dokumen ‚Äî by Bulan (Receive Date)</div>
    </div>
    <canvas id="chartDocsMonth" class="chart-documents"></canvas>
  </div>
</section>

    <!-- Sales -->
    <section id="sales" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Sales</h3>
        <div>
          <button id="addSalesBtn" class="btn primary">+ Tambah Sales</button>
          <button onclick="window.crudHandlers.openFilterModal('sales')" class="btn">üîç Filter</button>
          <button id="exportSales" class="btn">Export CSV</button>
          <button id="downloadSalesTemplate" class="btn">Download Template</button>
          <input id="importSalesFile" type="file" accept=".csv" class="hidden"/>
          <button id="importSalesBtn" class="btn">Import CSV</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="salesPageSize" onchange="window.crudHandlers.changePageSize('sales', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="transaction_date">Tanggal</th>
        <th class="sortable" data-column="invoice_no">Invoice</th>
        <th class="sortable" data-column="staff_name">Staff</th>
        <th class="sortable" data-column="sales_amount">Sales</th>
        <th class="sortable" data-column="profit_amount">Profit</th>
        <th>Aksi</th>
      </tr></thead><tbody id="tblSales"></tbody></table>
      <div class="pagination" id="salesPagination"></div>
    </section>

    <!-- Tours -->
    <section id="tours" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Tours</h3>
        <div>
          <button id="addTourBtn" class="btn primary">+ Tambah Tour</button>
          <button onclick="window.crudHandlers.openFilterModal('tours')" class="btn">üîç Filter</button>
          <button id="exportTours" class="btn">Export CSV</button>
          <button id="downloadToursTemplate" class="btn">Download Template</button>
          <input id="importToursFile" type="file" accept=".csv" class="hidden"/>
          <button id="importToursBtn" class="btn">Import CSV</button>
        </div>
      </div>
            <div class="searchbar">
        <input id="toursSearch" placeholder="Cari code / staff / region..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #d1d5db">
        <select id="toursPageSize" onchange="window.crudHandlers.changePageSize('tours', this.value)">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="registration_date">Reg</th>
        <th class="sortable" data-column="tour_code">Code</th>
        <th class="sortable" data-column="jumlah_peserta">Pax</th>
        <th class="sortable" data-column="departure_date">Depart</th>
        <th class="sortable" data-column="region_id">Region</th>
        <th class="sortable" data-column="staff_name">Staff</th>
        <th>Aksi</th>
      </tr></thead><tbody id="tblTours"></tbody></table>
      <div class="pagination" id="toursPagination"></div>
    </section>

    <!-- Documents -->
    <section id="documents" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Documents</h3>
        <div>
          <button id="addDocBtn" class="btn primary">+ Tambah Document</button>
          <button onclick="window.crudHandlers.openFilterModal('documents')" class="btn">üîç Filter</button>
          <button id="exportDocs" class="btn">Export CSV</button>
          <button id="downloadDocsTemplate" class="btn">Download Template</button>
          <input id="importDocsFile" type="file" accept=".csv" class="hidden"/>
          <button id="importDocsBtn" class="btn">Import CSV</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="docsPageSize" onchange="window.crudHandlers.changePageSize('documents', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="receive_date">Receive</th>
        <th class="sortable" data-column="guest_name">Guest</th>
        <th class="sortable" data-column="process_type">Process</th>
        <th class="sortable" data-column="staff_name">Staff</th>
        <th>Aksi</th>
      </tr></thead><tbody id="tblDocs"></tbody></table>
      <div class="pagination" id="docsPagination"></div>
    </section>

    <!-- Targets -->
    <section id="targets" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Targets</h3>
        <div>
          <button id="addTargetBtn" class="btn primary">+ Tambah Target</button>
          <button onclick="window.crudHandlers.openFilterModal('targets')" class="btn">üîç Filter</button>
          <button id="exportTargets" class="btn">Export CSV</button>
          <button id="downloadTargetsTemplate" class="btn">Download Template</button>
          <input id="importTargetsFile" type="file" accept=".csv" class="hidden"/>
          <button id="importTargetsBtn" class="btn">Import CSV</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="targetsPageSize" onchange="window.crudHandlers.changePageSize('targets', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="month">Bulan</th>
        <th class="sortable" data-column="year">Tahun</th>
        <th class="sortable" data-column="staff_name">Staff</th>
        <th class="sortable" data-column="target_sales">Target Sales</th>
        <th class="sortable" data-column="target_profit">Target Profit</th>
        <th>Aksi</th>
      </tr></thead>
      <tbody id="tblTargets"></tbody></table>
      <div class="pagination" id="targetsPagination"></div>
    </section>

    <!-- Regions -->
    <section id="regions" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Regions</h3>
        <div>
          <button id="addRegionBtn" class="btn primary">+ Tambah Region</button>
          <button onclick="window.crudHandlers.openFilterModal('regions')" class="btn">üîç Filter</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="regionsPageSize" onchange="window.crudHandlers.changePageSize('regions', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="id">ID</th>
        <th class="sortable" data-column="region_name">Region</th>
        <th>Aksi</th>
      </tr></thead><tbody id="tblRegions"></tbody></table>
      <div class="pagination" id="regionsPagination"></div>
    </section>

<section id="activity" class="section">
  <div class="controls"><h3>Riwayat Aktivitas</h3></div>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Waktu</th>
          <th>User</th>
          <th>Aksi</th>
          <th>Entitas</th>
          <th>ID</th>
          <th>Keterangan</th>
        </tr>
      </thead>
      <tbody id="tblActivity"></tbody>
    </table>
  </div>
</section>


    <!-- Users -->
    <section id="users" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Users</h3>
        <div>
          <button id="addUserBtn" class="btn primary">+ Tambah User</button>
          <button onclick="window.crudHandlers.openFilterModal('users')" class="btn">üîç Filter</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="usersPageSize" onchange="window.crudHandlers.changePageSize('users', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table"><thead><tr>
        <th class="sortable" data-column="username">Username</th>
        <th class="sortable" data-column="name">Name</th>
        <th class="sortable" data-column="type">Type</th>
        <th>Aksi</th>
      </tr></thead><tbody id="tblUsers"></tbody></table>
      <div class="pagination" id="usersPagination"></div>
    </section>

    <!-- Telecom -->
    <section id="telecom" class="card section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Telecom</h3>
        <div>
          <button id="addTelecomBtn" class="btn primary">+ Tambah Telecom</button>
          <button onclick="window.crudHandlers.openFilterModal('telecom')" class="btn">üîç Filter</button>
          <button id="exportTelecom" class="btn">Export CSV</button>
        </div>
      </div>
      <div class="searchbar">
        <select id="telecomPageSize" onchange="window.crudHandlers.changePageSize('telecom', this.value)" style="margin-left:auto">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th class="sortable" data-column="nama">Nama</th>
            <th class="sortable" data-column="no_telephone">No Telephone</th>
            <th class="sortable" data-column="type_product">Type Product</th>
            <th class="sortable" data-column="region_id">Negara</th>
            <th class="sortable" data-column="tanggal_mulai">Mulai</th>
            <th class="sortable" data-column="tanggal_selesai">Selesai</th>
            <th class="sortable" data-column="staff_name">Staff</th>
            <th class="sortable" data-column="deposit">Deposit</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tblTelecom"></tbody>
      </table>
      <div class="pagination" id="telecomPagination"></div>
    </section>

    <!-- Profile -->
    <section id="profile" class="section">
      <div class="profile-container">
        <!-- Profile Header Card -->
        <div class="card profile-header">
          <div class="profile-avatar">
            <div class="avatar-circle">
              <span id="profileInitials">?</span>
            </div>
          </div>
          <div class="profile-info">
            <h2 id="profileName">Loading...</h2>
            <p class="profile-role" id="profileRole">-</p>
            <p class="profile-username" id="profileUsername">@username</p>
          </div>
        </div>

        <!-- Profile Details Card -->
        <div class="card profile-details">
          <h3>Informasi Akun</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Username</label>
              <div id="detailUsername">-</div>
            </div>
            <div class="detail-item">
              <label>Nama Lengkap</label>
              <div id="detailName">-</div>
            </div>
            <div class="detail-item">
              <label>Email</label>
              <div id="detailEmail">-</div>
            </div>
            <div class="detail-item">
              <label>Tipe Akun</label>
              <div id="detailType">-</div>
            </div>
          </div>
        </div>

        <!-- Change Password Card -->
        <div class="card profile-password">
          <h3>Ubah Password</h3>
          <p class="small" style="margin-bottom: 16px; color: #6b7280;">
            Password minimal 8 karakter dan harus mengandung huruf besar, huruf kecil, serta angka.
          </p>
          <form id="pwForm">
            <div class="form-group">
              <label>Password Baru</label>
              <input type="password" name="password" required minlength="8" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).{8,}" placeholder="Min 8: huruf besar, kecil & angka">
            </div>
            <div class="form-group">
              <label>Konfirmasi Password</label>
              <input type="password" name="password_confirm" required minlength="8" pattern="(?=.*[a-z])(?=.*[A-Z])(?=.*\\d).{8,}" placeholder="Ketik ulang password baru">
            </div>
            <button class="btn btn-primary" type="submit">
              <span>üîí</span> Ubah Password
            </button>
          </form>
        </div>

        <!-- Activity Summary (if admin) -->
        <div class="card profile-stats" id="profileStats" style="display: none;">
          <h3>Statistik Aktivitas</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="statSales">0</div>
              <div class="stat-label">Total Sales</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statTours">0</div>
              <div class="stat-label">Total Tours</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statDocs">0</div>
              <div class="stat-label">Total Dokumen</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statTargets">0</div>
              <div class="stat-label">Total Targets</div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Enhanced Modal -->
<div id="modal" class="modal">
  <div class="modal-card">
    <div class="modal-header">
      <div id="modalTitle" class="modal-title"></div>
      <button type="button" class="modal-close" id="modalClose">&times;</button>
    </div>
    <form id="modalForm" class="modal-form">
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" id="modalCancel" class="btn btn-secondary">Batal</button>
        <button type="submit" id="modalSave" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script src="/js/crud-handlers.js"></script>
<script type="module">
/* =========================================================
   TRAVELOPS DASHBOARD SCRIPT ‚Äî FINAL CLEAN VERSION (v4.3)
   ========================================================= */

/* === GLOBAL HELPERS === */
const api = p => p.startsWith('/') ? p : '/' + p;
const el = id => document.getElementById(id);
const getUser = () => JSON.parse(localStorage.getItem('user') || '{}');

const getHeaders = (json = true) => {
  const h = {};
  const token = localStorage.getItem('token');
  if (token) h['Authorization'] = 'Bearer ' + token;
  if (json) h['Content-Type'] = 'application/json';
  return h;
};

async function fetchJson(url, opts = {}) {
  opts.headers = { ...(opts.headers || {}), ...getHeaders(!!opts.body) };
  if (opts.body && typeof opts.body === 'object' && opts.headers['Content-Type'] === 'application/json')
    opts.body = JSON.stringify(opts.body);
  const res = await fetch(api(url), opts);
  if (res.status === 401 || res.status === 403) {
    alert('Sesi login telah berakhir. Silakan login kembali.');
    localStorage.clear();
    location.href = '/login.html';
    return;
  }
  if (!res.ok) throw new Error(await res.text());
  try { return await res.json(); } catch { return null; }
}

// Export globally
window.fetchJson = fetchJson;
window.formatCurrency = formatCurrency;

const csvParse = text => {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
  const header = lines.shift().split(',').map(h => h.trim());
  return lines.map(l => {
    const cols = l.split(',');
    const obj = {};
    header.forEach((h, i) => obj[h] = cols[i] ? cols[i].trim() : '');
    return obj;
  });
};

const downloadFile = (filename, text) => {
  const blob = new Blob([text], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
};

function formatCurrency(v) {
  try { return 'Rp ' + Number(v || 0).toLocaleString('id-ID'); }
  catch { return v; }
}

/* === NAVIGATION === */
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  const t = el(name);
  if (t) t.classList.add('active');
  document.querySelectorAll('#mainNav button[data-section]').forEach(b => b.classList.toggle('active', b.dataset.section === name));
  localStorage.setItem('activeSection', name);
  
  // Render profile when profile section is shown
  if (name === 'profile') {
    renderProfile();
  }
}
document.querySelectorAll('#mainNav button[data-section]').forEach(b =>
  b.addEventListener('click', () => showSection(b.dataset.section))
);
window.addEventListener('DOMContentLoaded', () => {
  const s = localStorage.getItem('activeSection') || 'summary';
  showSection(s);
  refreshUser();
  startAutoRefresh();
});

/* === Enhanced Modal Handler === */
const modal = el('modal');
const modalTitle = el('modalTitle');
const modalBody = el('modalBody');
const modalForm = el('modalForm');
const modalClose = el('modalClose');

function openModal({ title, bodyHtml, context, size = 'medium' }) {
  // Reset form state
  if (modalForm) modalForm.reset();
  
  // Set modal content
  if (modalTitle) modalTitle.textContent = title;
  if (modalBody) modalBody.innerHTML = bodyHtml;
  if (modal) modal.dataset.context = JSON.stringify(context || {});
  
  // Set modal size
  const modalCard = modal?.querySelector('.modal-card');
  if (modalCard) modalCard.className = `modal-card modal-${size}`;
  
  // Show modal with animation
  if (modal) modal.classList.add('active');
  
  // Focus first input
  setTimeout(() => {
    const firstInput = modal?.querySelector('input:not([type="hidden"]), select, textarea');
    if (firstInput) firstInput.focus();
  }, 100);
  
  // Initialize any special inputs (datepicker, select2, etc)
  initializeModalInputs();
}

function closeModal(confirmed = false) {
  if (!modal) return;
  
  // Add closing animation
  modal.classList.add('closing');
  
  setTimeout(() => {
    modal.classList.remove('active', 'closing');
    if (modalBody) modalBody.innerHTML = '';
    delete modal.dataset.context;
    
    // Trigger onClose callback if exists
    if (modal.dataset.onClose) {
      try {
        const callback = new Function(modal.dataset.onClose);
        callback(confirmed);
      } catch (err) {
        console.error('Modal close callback error:', err);
      }
    }
  }, 200);
}

function initializeModalInputs() {
  if (!modalBody) return;
  
  // Add validation listeners
  const inputs = modalBody.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    input.addEventListener('invalid', (e) => {
      e.preventDefault();
      const formGroup = input.closest('.form-group');
      if (formGroup) {
        formGroup.classList.add('error');
        const errorElement = formGroup.querySelector('.error-message');
        if (!errorElement) {
          const error = document.createElement('div');
          error.className = 'error-message';
          error.textContent = input.validationMessage;
          formGroup.appendChild(error);
        }
      }
    });
    
    input.addEventListener('input', () => {
      const formGroup = input.closest('.form-group');
      if (formGroup) {
        formGroup.classList.remove('error');
        const errorElement = formGroup.querySelector('.error-message');
        if (errorElement) errorElement.remove();
      }
    });
  });
}

// Export modal functions globally
window.openModal = openModal;
window.closeModal = closeModal;

// Event Listeners
if (modalClose) modalClose.addEventListener('click', () => closeModal());
if (el('modalCancel')) el('modalCancel').addEventListener('click', () => closeModal());
if (modal) modal.addEventListener('click', e => {
  if (e.target === modal) closeModal();
});

// Handle form submission
if (modalForm) {
  modalForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
      if (modal) modal.classList.add('loading');
      
      // Get form data
      const formData = new FormData(modalForm);
      const data = Object.fromEntries(formData.entries());
      
      // Get context data
      const context = JSON.parse(modal?.dataset.context || '{}');
      
      // Call API based on context
      if (window.crudHandlers && window.crudHandlers.handleModalSubmit) {
        await window.crudHandlers.handleModalSubmit(data, context);
      }
      
      // Close modal on success
      closeModal(true);
      
      // Refresh data if needed
      if (context.entity && window.crudHandlers) {
        await window.crudHandlers.loadData(context.entity);
        window.crudHandlers.renderTable(context.entity);
      }
    } catch (err) {
      console.error('Form submission error:', err);
      // Show error message
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.style.padding = '12px';
      errorDiv.style.marginBottom = '16px';
      errorDiv.style.background = '#fee2e2';
      errorDiv.style.borderRadius = '8px';
      errorDiv.textContent = err.message || 'An error occurred';
      if (modalBody) modalBody.insertBefore(errorDiv, modalBody.firstChild);
    } finally {
      if (modal) modal.classList.remove('loading');
    }
  });
}

/* === ROLE HANDLER === */
function refreshUser() {
  const u = getUser();
  el('userName').textContent = u.name || u.username || '-';
  el('userRole').textContent = 'Role: ' + (u.type || '-');
  const isAdmin = u.type === 'admin';
  const isBasic = u.type === 'basic';
  if (!isAdmin) el('addTargetBtn').style.display = 'none';
  if (isBasic) document.querySelectorAll('.btn.delete').forEach(b => b.style.display = 'none');
  // Hide Users section and nav only for basic users (semiadmin can access)
  if (isBasic) {
    const usersSection = el('users');
    if (usersSection) usersSection.style.display = 'none';
    const usersNavBtn = document.querySelector('#mainNav button[data-section="users"]');
    if (usersNavBtn) usersNavBtn.style.display = 'none';
    // If currently on Users section, redirect to Dashboard
    const active = document.querySelector('.section.active');
    if (active && active.id === 'users') {
      showSection('summary');
    }
  }
}

/* === REFRESH ALL === */
async function refreshAll() {
  try {
    // Refresh charts
    await renderCharts();
    
    // Refresh CRUD data if handlers are loaded
    if (window.crudHandlers) {
      await Promise.all([
        window.crudHandlers.loadData('sales'),
        window.crudHandlers.loadData('tours'),
        window.crudHandlers.loadData('documents'),
        window.crudHandlers.loadData('targets')
      ]);
      
      // Re-render tables
      const activeSection = document.querySelector('.section.active');
      if (activeSection) {
        const sectionId = activeSection.id;
        if (['sales', 'tours', 'documents', 'targets', 'regions', 'users'].includes(sectionId)) {
          window.crudHandlers.renderTable(sectionId);
        }
      }
    }
    
    // Refresh profile if on profile page
    const activeSection = document.querySelector('.section.active');
    if (activeSection && activeSection.id === 'profile') {
      renderProfile();
    }
  } catch (err) {
    console.error('refreshAll', err);
  }
}

/* === AUTO REFRESH === */
let autoInterval = null;
function startAutoRefresh() {
  if (autoInterval) clearInterval(autoInterval);
  autoInterval = setInterval(() => refreshAll(), 30000);
}
function stopAutoRefresh() { if (autoInterval) clearInterval(autoInterval); autoInterval = null; }

/* === LOGOUT === */
// Direct navigation via anchor; no JS handler needed

/* === DASHBOARD CHARTS (Chart.js) === */
let charts = {};
async function renderCharts() {
  try {
    const month = el('globalMonth')?.value || '';
    const year = el('globalYear')?.value || '';
    const staff = el('globalStaff')?.value || '';
    const q = new URLSearchParams({ month, year, staff }).toString();
    const metrics = await fetchJson('/api/metrics' + (q ? '?' + q : ''));
    if (!metrics) return;

    const ctx = id => document.getElementById(id)?.getContext('2d');
    Object.values(charts).forEach(c => c.destroy());
    charts = {};

    const totalSales = metrics.sales?.total_sales || 0;
    const totalProfit = metrics.sales?.total_profit || 0;
    const targetSales = metrics.targets?.target_sales || 0;
    const targetProfit = metrics.targets?.target_profit || 0;

    el('totalSales').textContent = formatCurrency(totalSales);
    el('totalProfit').textContent = formatCurrency(totalProfit);
    el('salesAchievement').textContent = `Achv: ${(totalSales / (targetSales || 1) * 100).toFixed(1)}%`;
    el('profitAchievement').textContent = `Achv: ${(totalProfit / (targetProfit || 1) * 100).toFixed(1)}%`;
    el('totalParticipants').textContent = metrics.participants?.total_participants || 0;
    el('totalDocs').textContent = metrics.documents?.total_docs || 0;

    // Common chart options
    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            padding: 20,
            font: {
              family: 'Inter',
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(17, 24, 39, 0.95)',
          titleFont: {
            family: 'Inter',
            size: 13
          },
          bodyFont: {
            family: 'Inter',
            size: 12
          },
          padding: 12,
          cornerRadius: 8,
          boxPadding: 6
        }
      }
    };

    // Sales Chart
    charts.sales = new Chart(ctx('chartSalesTarget'), {
      type: 'bar',
      data: {
        labels: ['Sales', 'Target Sales'],
        datasets: [{
          data: [totalSales, targetSales],
          backgroundColor: ['#2563eb', '#93c5fd'],
          borderRadius: 6,
          borderWidth: 0
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              borderDash: [2, 4],
              color: 'rgba(0, 0, 0, 0.06)'
            },
            ticks: {
              callback: value => 'Rp ' + value.toLocaleString('id-ID')
            }
          }
        },
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Sales Performance',
            font: {
              size: 16,
              weight: '600'
            },
            padding: 20
          }
        }
      }
    });

    // Profit Chart
    charts.profit = new Chart(ctx('chartProfitTarget'), {
      type: 'bar',
      data: {
        labels: ['Profit', 'Target Profit'],
        datasets: [{
          data: [totalProfit, targetProfit],
          backgroundColor: ['#16a34a', '#86efac'],
          borderRadius: 6,
          borderWidth: 0
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              borderDash: [2, 4],
              color: 'rgba(0, 0, 0, 0.06)'
            },
            ticks: {
              callback: value => 'Rp ' + value.toLocaleString('id-ID')
            }
          }
        }
      }
    });

    // Document Type Chart
    const docs = metrics.documents || {};
    charts.docType = new Chart(ctx('chartDocType'), {
      type: 'doughnut',
      data: {
        labels: ['Normal', 'Kilat'],
        datasets: [{
          data: [docs.normal || 0, docs.kilat || 0],
          backgroundColor: ['#38bdf8', '#fbbf24'],
          borderWidth: 0,
          cutout: '60%'
        }]
      },
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          legend: {
            position: 'bottom'
          }
        }
      }
    });

    // Documents by Region Chart
    const docsRegion = metrics.participants_by_region || [];
    charts.docsRegion = new Chart(ctx('chartDocsRegion'), {
      type: 'bar',
      data: {
        labels: docsRegion.map(r => r.region_name),
        datasets: [{
          label: 'Participants',
          data: docsRegion.map(r => r.participants),
          backgroundColor: '#f87171',
          borderRadius: 6,
          borderWidth: 0
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              borderDash: [2, 4],
              color: 'rgba(0, 0, 0, 0.06)'
            }
          }
        }
      }
    });

    // Documents by Month Chart
    const docsMonth = metrics.participants_by_month || [];
    charts.docsMonth = new Chart(ctx('chartDocsMonth'), {
      type: 'line',
      data: {
        labels: docsMonth.map(m => 'Bulan ' + m.month),
        datasets: [{
          label: 'Participants',
          data: docsMonth.map(m => m.participants),
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          borderWidth: 2,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              borderDash: [2, 4],
              color: 'rgba(0, 0, 0, 0.06)'
            }
          }
        }
      }
    });

    charts.participantRegion = new Chart(ctx('chartParticipantRegion'), {
      type: 'bar',
      data: { labels: docsRegion.map(r => r.region_name), datasets: [{ data: docsRegion.map(r => r.participants), backgroundColor: '#10b981' }] },
      options: { plugins: { legend: { display: false } } }
    });

    charts.participantMonth = new Chart(ctx('chartParticipantMonth'), {
      type: 'bar',
      data: { labels: docsMonth.map(m => 'Bulan ' + m.month), datasets: [{ data: docsMonth.map(m => m.participants), backgroundColor: '#f97316' }] },
      options: { plugins: { legend: { display: false } } }
    });
  } catch (err) {
    console.error('renderCharts error', err);
  }
}

/* === ACTIVITY LOG === */
async function loadActivity() {
  if (getUser().type !== 'admin') return;
  try {
    const data = await fetchJson('/api/activity_logs');
    if (!data?.length) {
      el('tblActivity').innerHTML = '<tr><td colspan="6">Belum ada aktivitas</td></tr>';
      return;
    }
    const rows = data.map(r => `
      <tr>
        <td>${r.created_at}</td>
        <td>${r.username}</td>
        <td>${r.action}</td>
        <td>${r.entity}</td>
        <td>${r.record_id ?? '-'}</td>
        <td>${r.description ? r.description.slice(0,80) : '-'}</td>
      </tr>`).join('');
    el('tblActivity').innerHTML = rows;
  } catch (err) {
    console.error('Gagal memuat aktivitas:', err);
    el('tblActivity').innerHTML = '<tr><td colspan="6">Gagal memuat data</td></tr>';
  }
}

/* === PROFILE PAGE === */
function renderProfile() {
  const user = getUser();
  
  // Get initials
  const initials = user.name 
    ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)
    : user.username ? user.username[0].toUpperCase() : '?';
  
  // Update profile header
  if (el('profileInitials')) el('profileInitials').textContent = initials;
  if (el('profileName')) el('profileName').textContent = user.name || user.username || 'User';
  if (el('profileRole')) {
    const roleText = user.type === 'admin' ? 'Administrator' : 
                     user.type === 'semiadmin' ? 'Semi Admin' : 'Basic User';
    el('profileRole').textContent = roleText;
    el('profileRole').style.background = 
      user.type === 'admin' ? '#dbeafe' : 
      user.type === 'semiadmin' ? '#fef3c7' : '#e0e7ff';
    el('profileRole').style.color = 
      user.type === 'admin' ? '#1e40af' : 
      user.type === 'semiadmin' ? '#92400e' : '#4338ca';
  }
  if (el('profileUsername')) el('profileUsername').textContent = '@' + (user.username || 'unknown');
  
  // Update profile details
  if (el('detailUsername')) el('detailUsername').textContent = user.username || '-';
  if (el('detailName')) el('detailName').textContent = user.name || '-';
  if (el('detailEmail')) el('detailEmail').textContent = user.email || '-';
  if (el('detailType')) {
    const typeText = user.type === 'admin' ? 'Administrator' : 
                     user.type === 'semiadmin' ? 'Semi Admin' : 'Basic User';
    el('detailType').textContent = typeText;
  }
  
  // Load statistics if data is available
  loadProfileStats();
}

async function loadProfileStats() {
  const user = getUser();
  const statsCard = el('profileStats');
  
  if (!statsCard) return;
  
  try {
    // Show stats for all users
    statsCard.style.display = 'block';
    
    // Get user's data
    const sales = await fetchJson('/api/sales');
    const tours = await fetchJson('/api/tours');
    const documents = await fetchJson('/api/documents');
    const targets = await fetchJson('/api/targets');
    
    // Filter by user if not admin
    const userSales = user.type === 'admin' ? sales : sales.filter(s => s.staff_name === user.name);
    const userTours = user.type === 'admin' ? tours : tours.filter(t => t.staff_name === user.name);
    const userDocs = user.type === 'admin' ? documents : documents.filter(d => d.staff_name === user.name);
    const userTargets = user.type === 'admin' ? targets : targets.filter(t => t.staff_name === user.name);
    
    // Update stats
    if (el('statSales')) el('statSales').textContent = userSales.length;
    if (el('statTours')) el('statTours').textContent = userTours.length;
    if (el('statDocs')) el('statDocs').textContent = userDocs.length;
    if (el('statTargets')) el('statTargets').textContent = userTargets.length;
  } catch (err) {
    console.error('Error loading profile stats:', err);
  }
}

// Password change handler
if (el('pwForm')) {
  el('pwForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const password = formData.get('password');
    const passwordConfirm = formData.get('password_confirm');
    
    // Validate password
    if (password.length < 6) {
      alert('Password minimal 6 karakter');
      return;
    }
    
    if (password !== passwordConfirm) {
      alert('Password dan konfirmasi password tidak sama');
      return;
    }
    
    try {
      const user = getUser();
      await fetchJson('/api/users/reset-password', {
        method: 'POST',
        body: { username: user.username, password }
      });
      
      alert('Password berhasil diubah');
      e.target.reset();
    } catch (err) {
      alert('Gagal mengubah password: ' + err.message);
    }
  });
}

/* === INITIALIZATION === */
window.addEventListener('DOMContentLoaded', () => {
  renderCharts();
  setInterval(renderCharts, 30000);
  if (getUser().type === 'admin') loadActivity();
  
  // Wait for CRUD handlers to be ready
  setTimeout(() => {
    if (window.crudHandlers) {
      console.log('‚úÖ CRUD Handlers loaded successfully');
      
      // Wire up CRUD button handlers
      el('addSalesBtn')?.addEventListener('click', () => {
        console.log('Add Sales clicked');
        window.crudHandlers.openAddSalesModal();
      });
      el('addTourBtn')?.addEventListener('click', () => {
        console.log('Add Tour clicked');
        window.crudHandlers.openAddTourModal();
      });
      el('addDocBtn')?.addEventListener('click', () => {
        console.log('Add Doc clicked');
        window.crudHandlers.openAddDocModal();
      });
      el('addTargetBtn')?.addEventListener('click', () => {
        console.log('Add Target clicked');
        window.crudHandlers.openAddTargetModal();
      });
      el('addRegionBtn')?.addEventListener('click', () => {
        console.log('Add Region clicked');
        window.crudHandlers.openAddRegionModal();
      });
      el('addUserBtn')?.addEventListener('click', () => {
        console.log('Add User clicked');
        window.crudHandlers.openAddUserModal();
      });
      el('addTelecomBtn')?.addEventListener('click', () => {
        console.log('Add Telecom clicked');
        window.crudHandlers.openAddTelecomModal();
      });
      
      // Initialize CRUD handlers
      window.crudHandlers.init();
    } else {
      console.error('‚ùå CRUD Handlers not loaded');
    }
  }, 100);
});

// Make CRUD functions globally accessible
window.editSales = (id) => window.crudHandlers?.openEditSalesModal(id);
window.editTour = (id) => window.crudHandlers?.openEditTourModal(id);
window.editDoc = (id) => window.crudHandlers?.openEditDocModal(id);
window.editTarget = (id) => window.crudHandlers?.openEditTargetModal(id);
window.editRegion = (id) => window.crudHandlers?.openEditRegionModal(id);
window.editUser = (id) => window.crudHandlers?.openEditUserModal(id);
window.editTelecom = (id) => window.crudHandlers?.openEditTelecomModal(id);
window.deleteItem = (entity, id) => window.crudHandlers?.deleteItem(entity, id);

</script>

<!-- Removed logout confirmation modal; using direct navigation to /logout.html -->

</body>
</html>